{% extends 'base.html' %} {% block head %}
<!-- This data is now loaded first and available to all JS files -->
<script>
  window.clubData = {{ club_data_for_js|tojson }};
  window.clubLeagues = {{ club_leagues_for_js|tojson }};
  window.clubRevenue = {{ club_revenue|tojson }};
  const serverTimeNow = new Date('{{ now.isoformat() }}Z');
</script>
{% endblock %} {% block content %}
<style>
  /* --- Club Dashboard League List Styling --- */
  .leagues-section {
    margin-top: 2rem;
  }

  .leagues-section h2 {
    margin-bottom: 1rem;
    font-size: 1.5rem;
  }

  /* Override default table container styles for a card-based layout */
  .leaderboard-table-container {
    background-color: transparent;
    border: none;
    box-shadow: none;
  }

  .leaderboard-table {
    border-collapse: separate;
    border-spacing: 0 0.75rem; /* This creates the vertical space between rows (cards) */
  }

  .leaderboard-table thead {
    display: none; /* Hide the traditional table header as per the design */
  }

  .leaderboard-table tbody tr {
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .leaderboard-table tbody tr:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.07);
  }

  .leaderboard-table td {
    padding: 1.25rem;
    vertical-align: middle;
    border: none;
    border-bottom: 1px solid var(--border-color); /* Subtle line inside the card */
  }

  /* Apply border radius to the first and last cells to create the card shape */
  .leaderboard-table tr td:first-child {
    border-top-left-radius: var(--border-radius);
    border-bottom-left-radius: var(--border-radius);
  }
  .leaderboard-table tr td:last-child {
    border-top-right-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
  }

  /* These are needed to complete the card border effect with border-spacing */
  .leaderboard-table tbody tr td {
    border-top: 1px solid var(--border-color);
  }
  .leaderboard-table tbody tr td:first-child {
    border-left: 1px solid var(--border-color);
  }
  .leaderboard-table tbody tr td:last-child {
    border-right: 1px solid var(--border-color);
  }

  .leaderboard-table td small {
    display: block;
    color: var(--text-light);
    font-size: 0.8rem;
    margin-top: 0.25rem;
  }
</style>
<div class="dashboard-wrapper">
  {% include 'main/_shared_side_navbar.html' with context %}
  <div>{% include 'main/_shared_bottom_navbar.html' with context %}</div>
  <main class="dashboard-content">
    <header class="dashboard-hero">
      <div class="user-info">
        <div class="avatar">{{ current_user.club_name[0] }}</div>
        <div class="club-details">
          <h1>Welcome back, {{ current_user.club_name.split(' ')[0] }}!</h1>
          <a
            href="{{ url_for('league.create_league') }}"
            class="nav-item nav-item-club"
            id="create-league-btn-mobile"
          >
            <i class="fa-solid fa-plus"></i> Create League
          </a>
        </div>
        <p class="subtitle">Ready to raise some money?</p>

        <!-- <div class="user-level">
          <span>⭐ Level 15</span>
          <div class="xp-bar">
            <div class="xp-progress" style="width: 75%"></div>
          </div>
          <small>Next level: 250 XP</small>
        </div> -->
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="value">{{ active_leagues_count }}</span>
          <span class="label">Active Leagues</span>
        </div>
        <div class="stat-card">
          <span class="value">€{{ "%.2f"|format(club_revenue) }}</span>
          <span class="label">Total Revenue</span>
        </div>
        <div class="stat-card">
          <span class="value">{{ total_entries_count }}</span>
          <!-- <span class="value">{{ total_participants }}</span> -->
          <span class="label">Total Entries</span>
        </div>
      </div>
    </header>
    <div class="content-container">
      <section id="dashboard-section" class="page-section">
        <!-- <div class="header-actions">
          <a
            href="{{ url_for('league.create_league') }}"
            class="btn btn-primary"
          >
            <i class="fa-solid fa-plus"></i> Create New League
          </a>
        </div> -->
        <!-- Leagues Table -->
        <div class="leagues-section">
          <div class="leaderboard-table-container">
            <h2>My Leagues</h2>
            <div class="tabs-container">
              <div class="tabs capsule-tabs" id="club-league-tabs">
                <button class="tab-button active" data-status="Live">
                  Live
                </button>
                <button class="tab-button" data-status="Upcoming">
                  Upcoming
                </button>
                <button class="tab-button" data-status="Past">Past</button>
              </div>
            </div>

            <div class="leaderboard-table-container">
              <table class="leaderboard-table" id="club-leagues-table">
                <thead>
                  <tr>
                    <th>League Name</th>
                    <th class="text-center">Entries</th>
                    <th class="text-center">Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for league in club_leagues %}
                  <tr>
                    <td>
                      <strong>{{ league.name }}</strong><br />
                      <small>Code: {{ league.league_code }}</small>
                    </td>
                    <td class="text-center">{{ league.entries }}</td>
                    <td class="text-center">
                      <span class="tag tag-{{ league.status|lower }}"
                        >{{ league.status }}</span
                      >
                    </td>

                    <td class="text-right">
                      {% if not league.is_finalized and league.start_date > now
                      %}
                      <div class="share-box">
                        {% if league.league_code %}
                        <label>Access Code</label>
                        <div class="input-group">
                          <input
                            type="text"
                            class="form-control"
                            value="{{ league.access_code }}"
                            readonly
                            id="access-code-{{ league.id }}"
                          />
                          <div class="input-group-append">
                            <button
                              class="btn btn-outline-secondary copy-btn"
                              data-target="#access-code-{{ league.id }}"
                            >
                              Copy
                            </button>
                          </div>
                        </div>
                        {% else %}
                        <label>Share Link</label>
                        <div class="input-group">
                          <input
                            type="text"
                            class="form-control"
                            value="{{ url_for('league.view_league', league_id=league.id, _external=True) }}"
                            readonly
                            id="share-link-{{ league.id }}"
                          />
                          <div class="input-group-append">
                            <button
                              class="btn btn-outline-secondary copy-btn"
                              data-target="#share-link-{{ league.id }}"
                            >
                              Copy
                            </button>
                          </div>
                        </div>
                        {% endif %}
                      </div>
                      {% endif %}
                      <a
                        href="{{ url_for('league.club_league_view', league_id=league.id) }}"
                        class="btn btn-outline"
                        >View</a
                      >
                      {% if not league.is_finalized and league.start_date > now
                      %}
                      <a
                        href="{{ url_for('league.edit_league', league_id=league.id) }}"
                        class="btn btn-sm btn-info"
                        >Edit</a
                      >

                      <form
                        action="{{ url_for('league.cancel_league', league_id=league.id) }}"
                        method="POST"
                        style="display: inline"
                        onsubmit="return confirm('Are you sure you want to cancel this league? All entry fees will be refunded and this action cannot be undone.');"
                      >
                        <button type="submit" class="btn btn-sm btn-danger">
                          Cancel
                        </button>
                      </form>
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="4" class="text-center" style="padding: 2rem">
                      You haven't created any leagues yet.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="wallet-section" class="page-section hidden">
        <header class="dashboard-header">
          <div>
            <h1>Wallet & Payments</h1>
            <p class="subtitle">
              Manage your payment details and tournament winnings
            </p>
          </div>
        </header>
        <div class="wallet-grid">
          <div class="info-card">
            <h4>Payment Account Status</h4>
            {% if not current_user.stripe_account_id %}
            <div class="alert warning">
              <i class="fa-solid fa-triangle-exclamation"></i>
              <div>
                <strong>Setup Required</strong>
                <span>Connect your payment account to receive winnings.</span>
              </div>
            </div>
            {% else %}
            <div class="alert success">
              <i class="fa-regular fa-circle-check"></i>
              <div>
                <strong>Setup Complete</strong>
                <span>Stripe account connected.</span>
              </div>
            </div>
            {% endif %}
            <h5>Why connect Stripe?</h5>
            <ul class="feature-list">
              <li>Secure, encrypted payment processing</li>
              <li>Fast tournament winnings deposits</li>
              <li>Automatic tax document generation</li>
              <li>24/7 fraud protection and monitoring</li>
            </ul>
          </div>
          <div class="info-card">
            <h4>Security & Privacy</h4>
            <div class="alert info">
              <i class="fa-solid fa-shield-halved"></i>
              <div>
                <strong>Your data is protected</strong>
                <span
                  >We use Stripe's enterprise-grade security to protect your
                  financial information.</span
                >
              </div>
            </div>
            <h5>Security Features</h5>
            <ul class="feature-list">
              <li>PCI DSS Level 1 compliance</li>
              <li>256-bit SSL encryption</li>
              <li>Two-factor authentication</li>
              <li>Real-time fraud detection</li>
            </ul>
          </div>
        </div>
        <form action="{{ url_for('main.onboard_stripe') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button type="submit" class="btn btn-primary">
            {% if current_user.stripe_account_id %} Edit Stripe Details {%else%}
            Connect Stripe Account {% endif %}
          </button>
        </form>
        <!-- <div class="form-card earnings-overview">
          <h4>Earnings Overview</h4>
          <div class="earnings-grid">
            <div class="earnings-stat">
              <i class="fa-solid fa-dollar-sign icon"></i>
              <strong>$0.00</strong>
              <span>Total Earnings</span>
            </div>
            <div class="earnings-stat">
              <i class="fa-regular fa-clock icon"></i>
              <strong>$0.00</strong>
              <span>Pending Winnings</span>
            </div>
            <div class="earnings-stat">
              <i class="fa-solid fa-trophy icon"></i>
              <strong>0</strong>
              <span>Tournaments Won</span>
            </div>
          </div>
        </div> -->
        <!-- <div class="form-card text-center">
          <h4>Ready to receive your winnings?</h4>
          <p>
            Connect your Stripe account to start receiving tournament winnings
            directly to your bank account. The setup process takes just a few
            minutes and is completely secure.
          </p>


        </div> -->
      </section>

      {% include 'main/_shared_dashboard_sections.html' %}
    </div>
  </main>
</div>

{% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".copy-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const targetInput = document.querySelector(this.dataset.target);
        targetInput.select();
        document.execCommand("copy");
        this.textContent = "Copied!";
        setTimeout(() => {
          this.textContent = "Copy";
        }, 2000);
      });
    });
  });
</script>
{% endblock %}
