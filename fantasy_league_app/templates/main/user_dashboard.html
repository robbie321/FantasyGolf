{% extends 'base.html' %} {% block head %}
<!-- Enhanced fonts for professional look -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
  rel="stylesheet"
/>

<!-- Dashboard data for JavaScript -->
<script>
  window.serverTimeNow = new Date({{ now | tojson }});
  window.liveLeaguesData = {{ live_leagues | tojson }};
  window.upcomingLeaguesData = {{ upcoming_leagues | tojson }};
  window.pastLeaguesData = {{ past_leagues | tojson }};
</script>
{% endblock %} {% block content %}
<div class="dashboard-wrapper">
  <!-- Professional Sidebar -->
  {% include 'main/_shared_side_navbar.html' with context %}

  <!-- Mobile Navigation -->
  {% include 'main/_shared_bottom_navbar.html' with context %}

  <!-- Main Dashboard Content -->
  <main class="dashboard-content">
    <!-- Professional Hero Section -->
    <header class="dashboard-hero">
      <div class="user-info">
        <div class="avatar">{{ current_user.full_name[0]|upper }}</div>

        <div class="user-details">
          <div class="welcome-message">
            <h1>Welcome back, {{ current_user.full_name.split(' ')[0] }}!</h1>
            <p class="dashboard-subheading">
              Here's a look at your current leagues and performance.
            </p>
          </div>

          <div class="join-league-box">
            <button class="join-league-hero-btn" id="join-league-btn">
              <i class="fa-solid fa-plus"></i>
              Join a League
            </button>
          </div>
        </div>
      </div>

      <!-- Professional Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <span class="value"
            >{{ live_leagues|length + upcoming_leagues|length }}</span
          >
          <span class="label">Active Leagues</span>
        </div>
        <div class="stat-card">
          <span class="value">{{ stats.leagues_played }}</span>
          <span class="label">Total Entered</span>
        </div>
        <div class="stat-card">
          <span class="value">{{ stats.leagues_won }}</span>
          <span class="label">Leagues Won</span>
        </div>
      </div>
    </header>

    <!-- Main Content Container -->
    <div class="content-container">
      <!-- Dashboard Section - My Leagues -->
      <section id="dashboard-section" class="page-section">
        <div class="leagues-section">
          <h2>
            <i class="fa-solid fa-trophy"></i>
            My Leagues
          </h2>

          <!-- Professional Tab Navigation -->
          <div class="tabs-container">
            <div class="tabs capsule-tabs league-tabs" id="league-tabs">
              <button class="tab-button active" data-status="live">
                <i class="fa-solid fa-circle"></i>
                Live
              </button>
              <button class="tab-button" data-status="upcoming">
                <i class="fa-solid fa-clock"></i>
                Upcoming
              </button>
              <button class="tab-button" data-status="past">
                <i class="fa-solid fa-flag-checkered"></i>
                Past
              </button>
            </div>
          </div>

          <!-- League Cards Grid -->
          <div class="leagues-grid" id="leagues-grid">
            <!-- League cards will be populated by JavaScript -->
          </div>

          <!-- Empty State -->
          <div class="empty-state" id="empty-state" style="display: none">
            <div class="empty-content">
              <i class="fa-solid fa-trophy"></i>
              <h3>No leagues found</h3>
              <p>You haven't joined any leagues in this category yet.</p>
              <button class="btn btn-primary" id="join-first-league-btn">
                <i class="fa-solid fa-plus"></i>
                Join Your First League
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="settings-section" class="page-section hidden">
        <header class="dashboard-header">
          <div>
            <h1>
              <i class="fa-solid fa-gear"></i>
              Account Settings
            </h1>
            <p class="subtitle">
              Manage your account preferences and notification settings
            </p>
          </div>
        </header>
      </section>

      <!-- Include Shared Dashboard Sections -->
      {% include 'main/_shared_dashboard_sections.html' with context %}
    </div>
  </main>
</div>

<!-- Professional JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Professional User Dashboard Initialized");

    // League data from server
    const liveLeagues = window.liveLeaguesData || [];
    const upcomingLeagues = window.upcomingLeaguesData || [];
    const pastLeagues = window.pastLeaguesData || [];

    // DOM elements
    const tabButtons = document.querySelectorAll(".tab-button");
    const leaguesGrid = document.getElementById("leagues-grid");
    const emptyState = document.getElementById("empty-state");
    const joinLeagueBtn = document.getElementById("join-league-btn");
    const joinFirstLeagueBtn = document.getElementById("join-first-league-btn");

    // Current active status
    let currentStatus = "live";

    // League card template
    function createLeagueCard(league) {
      const isLive = currentStatus === "live";
      const isUpcoming = currentStatus === "upcoming";
      const isPast = currentStatus === "past";

      // Determine rank badge
      let rankBadge = "";
      if (league.current_rank && (isLive || isPast)) {
        let rankClass = "rank-standard";
        let rankIcon = "";

        if (league.current_rank === 1) {
          rankClass = "rank-gold";
          rankIcon = '<i class="fa-solid fa-crown"></i>';
        } else if (league.current_rank === 2) {
          rankClass = "rank-silver";
          rankIcon = '<i class="fa-solid fa-medal"></i>';
        } else if (league.current_rank === 3) {
          rankClass = "rank-bronze";
          rankIcon = '<i class="fa-solid fa-medal"></i>';
        }

        rankBadge = `
                <div class="rank-badge ${rankClass}">
                    ${rankIcon}
                    Rank #${league.current_rank}
                </div>
            `;
      }

      // Determine status badge
      let statusBadge = "";
      let statusClass = "";
      if (isLive) {
        statusClass = "status-live";
        statusBadge = '<i class="fa-solid fa-circle"></i> Live';
      } else if (isUpcoming) {
        statusClass = "status-upcoming";
        statusBadge = '<i class="fa-solid fa-clock"></i> Upcoming';
      } else {
        statusClass = "status-completed";
        statusBadge = '<i class="fa-solid fa-flag-checkered"></i> Completed';
      }

      // Format dates
      const startDate = new Date(league.start_date).toLocaleDateString();
      const endDate = new Date(league.end_date).toLocaleDateString();

      return `
            <a href="/view/${league.id}" class="dashboard-league-card">
                <div class="card-header">
                    <div class="card-title-group">
                        <h3 class="league-name">${league.name}</h3>
                        ${rankBadge}
                    </div>
                    <div class="status-and-tour">
                        <span class="tour-tag-small">${league.tour.toUpperCase()}</span>
                        <span class="status-badge ${statusClass}">${statusBadge}</span>
                    </div>
                </div>

                <div class="card-info-grid">
                    <div class="info-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        <div class="info-text">
                            <span class="label">Entry Fee</span>
                            <span class="value">€${parseFloat(
                              league.entry_fee || 0
                            ).toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="info-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <div class="info-text">
                            <span class="label">Participants</span>
                            <span class="value">${
                              league.total_entries || 0
                            }</span>
                        </div>
                    </div>

                    <div class="info-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                            <line x1="7" y1="7" x2="7.01" y2="7"></line>
                        </svg>
                        <div class="info-text">
                            <span class="label">Prize Pool</span>
                            <span class="value">€${parseFloat(
                              league.prize_amount || 0
                            ).toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="info-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <div class="info-text">
                            <span class="label">${
                              isUpcoming ? "Starts" : "Tournament"
                            }</span>
                            <span class="value">${
                              isUpcoming
                                ? startDate
                                : `${startDate} - ${endDate}`
                            }</span>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <span>
                        ${
                          isPast
                            ? "View Results"
                            : isLive
                            ? "View Leaderboard"
                            : "View Details"
                        }
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </div>
            </a>
        `;
    }

    // Render leagues function
    function renderLeagues(status) {
      let leagues = [];

      switch (status) {
        case "live":
          leagues = liveLeagues;
          break;
        case "upcoming":
          leagues = upcomingLeagues;
          break;
        case "past":
          leagues = pastLeagues;
          break;
      }

      if (leagues.length === 0) {
        leaguesGrid.style.display = "none";
        emptyState.style.display = "block";

        // Update empty state content based on status
        const emptyContent = emptyState.querySelector(".empty-content");
        const icon = emptyContent.querySelector("i");
        const title = emptyContent.querySelector("h3");
        const description = emptyContent.querySelector("p");

        switch (status) {
          case "live":
            icon.className = "fa-solid fa-circle";
            title.textContent = "No live leagues";
            description.textContent =
              "You don't have any active leagues at the moment.";
            break;
          case "upcoming":
            icon.className = "fa-solid fa-clock";
            title.textContent = "No upcoming leagues";
            description.textContent =
              "You haven't joined any upcoming tournaments yet.";
            break;
          case "past":
            icon.className = "fa-solid fa-flag-checkered";
            title.textContent = "No completed leagues";
            description.textContent = "You haven't completed any leagues yet.";
            break;
        }
      } else {
        leaguesGrid.style.display = "grid";
        emptyState.style.display = "none";

        leaguesGrid.innerHTML = leagues
          .map((league) => createLeagueCard(league))
          .join("");
      }
    }

    // Tab switching functionality
    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        // Update active tab
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        // Update current status and render
        currentStatus = button.dataset.status;
        renderLeagues(currentStatus);
      });
    });

    // Join league functionality
    function openJoinLeagueModal() {
      const modal = document.getElementById("join-league-overlay");
      if (modal) {
        modal.classList.remove("hidden");
      }
    }

    if (joinLeagueBtn) {
      joinLeagueBtn.addEventListener("click", openJoinLeagueModal);
    }

    if (joinFirstLeagueBtn) {
      joinFirstLeagueBtn.addEventListener("click", openJoinLeagueModal);
    }

    // Initial render
    renderLeagues("live");

    // Settings form handling
    const profileForm = document.querySelector(".profile-form");
    const notificationForm = document.querySelector(".notification-form");

    if (profileForm) {
      profileForm.addEventListener("submit", function (e) {
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
      });
    }

    if (notificationForm) {
      notificationForm.addEventListener("submit", function (e) {
        const submitBtn = notificationForm.querySelector(
          'button[type="submit"]'
        );
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
      });
    }

    console.log(
      "Dashboard loaded with",
      {
        live: liveLeagues.length,
        upcoming: upcomingLeagues.length,
        past: pastLeagues.length,
      },
      "leagues"
    );
  });
</script>

<style>
  /* Additional Professional Styles */
  .empty-content {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    background: var(--white);
    border-radius: var(--border-radius-lg);
    border: 2px dashed var(--surface-border);
  }

  .empty-content i {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    color: var(--text-muted);
    opacity: 0.5;
  }

  .empty-content h3 {
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .empty-content p {
    color: var(--text-secondary);
    font-size: 1.125rem;
    margin-bottom: 2rem;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Settings Grid */
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .settings-card {
    background: var(--white);
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .settings-card-header {
    background: var(--surface-light);
    padding: 1.5rem;
    border-bottom: 1px solid var(--surface-border);
  }

  .settings-card-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .settings-card-body {
    padding: 2rem;
  }

  .profile-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--surface-border);
  }

  .avatar-placeholder {
    width: 80px;
    height: 80px;
    background: var(--primary-gradient);
    color: var(--white);
    font-size: 1.5rem;
    font-weight: 700;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid var(--surface-border);
  }

  .profile-info h4 {
    margin: 0 0 0.25rem 0;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
  }

  .profile-info p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  .input-group label {
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .input-group input {
    padding: 0.75rem 1rem;
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition);
    background: var(--white);
  }

  .input-group input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(0, 106, 78, 0.1);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
  }

  .toggle-group {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--surface-border);
    gap: 2rem;
  }

  .toggle-group:last-child {
    border-bottom: none;
  }

  .toggle-info {
    flex: 1;
  }

  .toggle-info h5 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
  }

  .toggle-info p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.4;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
    flex-shrink: 0;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: var(--transition);
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: var(--transition);
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: var(--primary-green);
  }

  input:checked + .slider:before {
    transform: translateX(22px);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .settings-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .profile-header {
      flex-direction: column;
      text-align: center;
      gap: 1rem;
    }

    .toggle-group {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }

    .form-actions {
      justify-content: stretch;
    }

    .form-actions .btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .settings-card-body {
      padding: 1.5rem;
    }

    .settings-card-header {
      padding: 1rem;
    }

    .avatar-placeholder {
      width: 60px;
      height: 60px;
      font-size: 1.25rem;
    }

    .toggle-group {
      padding: 1rem 0;
    }
  }
</style>

{% endblock %}
