{% extends 'base.html' %} {% block content %}
<!-- Link to the new stylesheet -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/dashboards.css') }}"
/>

<div class="page-wrapper">
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-text">
        <h1>Dashboard</h1>
        <p>Manage your leagues and track your performance</p>
      </div>
      <div class="header-actions">
        <a href="#" class="action-btn primary" id="join-league-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-plus w-5 h-5 mr-2"
            aria-hidden="true"
          >
            <path d="M5 12h14"></path>
            <path d="M12 5v14"></path>
          </svg>

          Join a League</a
        >
        <a
          href="{{ url_for('league.create_user_league') }}"
          class="btn btn-secondary"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-plus w-5 h-5 mr-2"
            aria-hidden="true"
          >
            <path d="M5 12h14"></path>
            <path d="M12 5v14"></path>
          </svg>
          Create a League</a
        >
      </div>
    </div>

    <!-- Slider Tabs -->
    <div class="tabs-container">
      <div class="tab active" data-tab="my-leagues">My Leagues</div>
      <div class="tab" data-tab="my-profile">My Profile</div>
    </div>

    <div class="tab-content active" id="my-leagues">
      <div class="league-category">
        <h2 class="category-title">
          <span class="live-indicator"></span>
          Live Leagues
          <span class="count-badge">{{ live_leagues|length }}</span>
        </h2>
        {% if live_leagues %}
        <div class="dashboard-leagues-grid">
          {% for data in live_leagues %} {% include
          'main/_dashboard_league_card.html' with context %} {% endfor %}
        </div>
        {% else %}
        <p class="no-leagues-text">No active leagues right now.</p>
        {% endif %}
      </div>

      <div class="league-category">
        <h2 class="category-title">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-clock w-5 h-5 text-blue-600"
            aria-hidden="true"
          >
            <path d="M12 6v6l4 2"></path>
            <circle cx="12" cy="12" r="10"></circle>
          </svg>
          Upcoming Leagues
          <span class="count-badge">{{ upcoming_leagues|length }}</span>
        </h2>
        {% if upcoming_leagues %}
        <div class="dashboard-leagues-grid">
          {% for data in upcoming_leagues %} {% include
          'main/_dashboard_league_card.html' with context %} {% endfor %}
        </div>
        {% else %}
        <p class="no-leagues-text">No upcoming leagues. Why not create one?</p>
        {% endif %}
      </div>

      <div class="league-category">
        <h2 class="category-title">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-trophy w-5 h-5 text-slate-600"
            aria-hidden="true"
          >
            <path
              d="M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"
            ></path>
            <path
              d="M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"
            ></path>
            <path d="M18 9h1.5a1 1 0 0 0 0-5H18"></path>
            <path d="M4 22h16"></path>
            <path
              d="M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"
            ></path>
            <path d="M6 9H4.5a1 1 0 0 1 0-5H6"></path>
          </svg>
          Past Leagues
          <span class="count-badge">{{ past_leagues|length }}</span>
        </h2>
        {% if past_leagues %}
        <div class="dashboard-leagues-grid">
          {% for data in past_leagues %} {% include
          'main/_dashboard_league_card.html' with context %} {% endfor %}
        </div>
        {% else %}
        <p class="no-leagues-text">No past leagues to show.</p>
        {% endif %}
      </div>
    </div>

    <!-- Profile Content -->
    <div id="my-profile" class="tab-content">
      <div class="profile-section">
        <h2>My Profile</h2>
        <p>Manage your account details and payout information.</p>
        <form action="{{ url_for('main.onboard_stripe') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button type="submit" class="action-btn primary">
            Update Stripe Payout Details
          </button>
        </form>

        <button id="enable-notifications-btn" class="btn btn-primary">
          Enable Notifications
        </button>
        <p id="notification-status" style="margin-top: 1rem; color: #666"></p>
      </div>
    </div>
  </div>
</div>
<div class="popup-overlay" id="join-league-overlay">
  <div class="popup-container" id="join-league-popup">
    <button class="popup-close" id="popup-close-btn">&times;</button>
    <h3>Join a League</h3>
    <p>Enter the 8-character code for the league you want to join.</p>
    <form action="{{ url_for('league.join_league') }}" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="form-group">
        <input
          type="text"
          name="league_code"
          placeholder="e.g. A1B2C3D4"
          required
          minlength="6"
          maxlength="6"
        />
      </div>
      <button type="submit" class="action-btn primary full-width">
        Submit Code
      </button>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll(".tab");
    const tabContents = document.querySelectorAll(".tab-content");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        // Deactivate all tabs and content
        tabs.forEach((t) => t.classList.remove("active"));
        tabContents.forEach((c) => c.classList.remove("active"));

        // Activate the clicked tab and its content
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    const enableBtn = document.getElementById("enable-notifications-btn");
    const statusEl = document.getElementById("notification-status");
    if ("serviceWorker" in navigator && "PushManager" in window) {
      enableBtn.addEventListener("click", () => {
        askPermissionAndSubscribe();
      });
    } else {
      statusEl.textContent =
        "Push notifications are not supported on this browser.";
      enableBtn.disabled = true;
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, "+")
        .replace(/_/g, "/");
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function askPermissionAndSubscribe() {
      console.log("DEBUG: 'Enable Notifications' button clicked.");
      statusEl.textContent = "Requesting permission...";

      try {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          statusEl.textContent = "Permission was not granted.";
          console.log("DEBUG: Notification permission denied.");
          return;
        }

        console.log("DEBUG: Notification permission granted.");
        statusEl.textContent = "Permission granted. Subscribing...";

        console.log("DEBUG: Waiting for service worker to be ready...");
        const registration = await navigator.serviceWorker.ready;
        console.log("DEBUG: Service worker is ready.");

        console.log(
          "DEBUG: Fetching VAPID public key from /api/vapid_public_key..."
        );
        const response = await fetch("/api/vapid_public_key");

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(
            `Failed to fetch VAPID public key. Server responded with ${response.status}: ${errorText}`
          );
        }

        const data = await response.json();
        const vapidPublicKey = data.public_key;

        console.log(
          "DEBUG: Received VAPID public key from server:",
          vapidPublicKey
        );

        console.log(
          "DEBUG: 1. Raw VAPID public key from server:",
          vapidPublicKey
        );

        if (!vapidPublicKey) {
          throw new Error("VAPID public key from server was empty.");
        }

        try {
          const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
          console.log(
            "DEBUG: 2. VAPID key after conversion (Uint8Array):",
            applicationServerKey
          );
          console.log("DEBUG: VAPID key converted successfully.");

          console.log("DEBUG: Subscribing with push manager...");
          const options = {
            userVisibleOnly: true,
            applicationServerKey: applicationServerKey,
          };
          const subscription = await registration.pushManager.subscribe(
            options
          );
          console.log(JSON.stringify(subscription));
        } catch (err) {
          console.log("Error", err);
        }

        // --- START: THIS IS THE MISSING PART ---

        console.log(
          "DEBUG: Successfully subscribed with push service. Sending to server..."
        );
        statusEl.textContent = "Saving subscription...";

        const subscribeResponse = await fetch("/api/subscribe", {
          method: "POST",
          body: JSON.stringify(subscription),
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}", // For CSRF protection
          },
        });

        if (subscribeResponse.ok) {
          console.log("DEBUG: User is successfully subscribed on the server.");
          statusEl.textContent = "✅ Notifications Enabled!";
          enableBtn.disabled = true;
        } else {
          const errorText = await subscribeResponse.text();
          throw new Error(
            "Failed to save subscription on server. Response: " + errorText
          );
        }

        // --- END: THIS IS THE MISSING PART ---
      } catch (error) {
        console.error("!!! PUSH NOTIFICATION ERROR:", error);
        statusEl.textContent =
          "Error: Could not subscribe. See console for details.";
      }
    }
  });

  // --- Join League Popup Logic ---
  const joinLeagueBtn = document.getElementById("join-league-btn");
  const joinLeagueOverlay = document.getElementById("join-league-overlay");
  const popupCloseBtn = document.getElementById("popup-close-btn");

  if (joinLeagueBtn) {
    joinLeagueBtn.addEventListener("click", () => {
      joinLeagueOverlay.classList.add("active");
    });
  }
  if (popupCloseBtn) {
    popupCloseBtn.addEventListener("click", () => {
      joinLeagueOverlay.classList.remove("active");
    });
  }
  if (joinLeagueOverlay) {
    joinLeagueOverlay.addEventListener("click", (e) => {
      if (e.target === joinLeagueOverlay) {
        joinLeagueOverlay.classList.remove("active");
      }
    });
  }
</script>
{% endblock %}
