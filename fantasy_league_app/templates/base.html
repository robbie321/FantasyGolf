<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fantasy Fairways</title>
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    {% block head %}{% endblock %}
  </head>
  <body>
    <div id="mobile-menu-overlay" class="mobile-menu-overlay"></div>

    <nav class="navbar">
      <a href="{{ url_for('main.index') }}" class="navbar-brand">
        <img
          src="{{ url_for('static', filename='images/logo/logo.svg') }}"
          alt="Fantasy Fairways Logo"
        />
      </a>

      <div class="navbar-links" id="navbar-links">
        <div class="navbar-links-wrapper">
          <a href="{{ url_for('main.browse_leagues') }}">Browse Leagues</a>
          {% if current_user.is_authenticated %}
          <div class="navbar-dropdown">
            <button class="dropdown-button" onclick="toggleDropdown()">
              {{ current_user.full_name or current_user.username }}
              <span class="arrow"></span>
            </button>
            <div class="dropdown-content" id="myDropdown">
              {% if current_user.is_site_admin %}
              <a href="{{ url_for('admin.admin_dashboard') }}"
                >Admin Dashboard</a
              >
              {% elif current_user.is_club_admin %}
              <a href="{{ url_for('main.club_dashboard') }}">Club Dashboard</a>
              {% else %}
              <a href="{{ url_for('main.user_dashboard') }}">My Dashboard</a>
              {% endif %}
              <a href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
          </div>
          {% else %}
          <a href="{{ url_for('auth.login_choice') }}">Login</a>
          <a href="{{ url_for('auth.register') }}" class="btn btn-outline"
            >Register</a
          >
          {% endif %}
        </div>
      </div>

      <button
        class="navbar-toggle"
        id="navbar-toggle"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggle-icon"></span>
      </button>
    </nav>

    <!-- {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div
      class="flash-modal-overlay"
      id="flash-modal-overlay"
      style="display: flex"
    >
      <div class="flash-modal-content">
        <span class="flash-modal-close-btn" id="flash-modal-close-btn"
          >&times;</span
        >
        {% for category, message in messages %}
        <div class="flash-{{ category }}">
          <h2>{{ category|capitalize }}</h2>
          <p>{{ message }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %} {% endwith %} -->

    <div class="toast-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div class="toast toast--{{ category }}">
        <div class="toast__content">
          <p class="toast__message">{{ message }}</p>
        </div>
        <button class="toast__close">&times;</button>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <main>{% block content %}{% endblock %}</main>
    {% if current_user.is_authenticated %}
    <nav class="bottom-nav">
      <a
        href="{{ url_for('main.user_dashboard') }}"
        class="bottom-nav__link {% if request.endpoint == 'main.user_dashboard' %}active{% endif %}"
      >
        <svg
          class="bottom-nav__icon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="bottom-nav__text">Dashboard</span>
      </a>
      <a
        href="{{ url_for('main.browse_leagues') }}"
        class="bottom-nav__link {% if request.endpoint == 'main.browse_leagues' %}active{% endif %}"
      >
        <svg
          class="bottom-nav__icon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <span class="bottom-nav__text">Browse</span>
      </a>
      <a
        href="{{ url_for('player.rankings') }}"
        class="bottom-nav__link {% if request.endpoint == 'player.rankings' %}active{% endif %}"
      >
        <svg
          class="bottom-nav__icon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
          <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
          <path d="M4 22h16"></path>
          <path
            d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"
          ></path>
          <path
            d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"
          ></path>
          <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
        </svg>
        <span class="bottom-nav__text">Rankings</span>
      </a>
      <a href="{{ url_for('main.user_dashboard') }}" class="bottom-nav__link">
        <svg
          class="bottom-nav__icon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span class="bottom-nav__text">More</span>
      </a>
    </nav>
    {% endif %}
    <script>
        function toggleDropdown() {
          document.getElementById("myDropdown").classList.toggle("show");
        }
        // Close dropdown if clicking outside
        window.onclick = function (event) {
          if (!event.target.matches(".dropdown-button")) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
              var openDropdown = dropdowns[i];
              if (openDropdown.classList.contains("show")) {
                openDropdown.classList.remove("show");
              }
            }
          }
        };

        document.addEventListener("DOMContentLoaded", function () {
          const toggler = document.getElementById("navbar-toggler-btn");
          const linksContainer = document.getElementById(
            "navbar-links-container"
          );

          if (toggler && linksContainer) {
            toggler.addEventListener("click", function () {
              linksContainer.classList.toggle("is-active");
              toggler.classList.toggle("is-active");
            });
          }
        });

        // --- Toast Notification Logic ---
        document.addEventListener("DOMContentLoaded", () => {
          const toasts = document.querySelectorAll(".toast");

          toasts.forEach((toast, index) => {
            // Stagger the appearance of multiple toasts
            setTimeout(() => {
              toast.classList.add("show");
            }, index * 200);

            // Auto-hide after 5 seconds
            const timer = setTimeout(() => {
              toast.classList.remove("show");
              setTimeout(() => toast.remove(), 500); // Remove from DOM after animation
            }, 5000);

            // Allow manual closing
            const closeButton = toast.querySelector(".toast__close");
            if (closeButton) {
              closeButton.addEventListener("click", () => {
                clearTimeout(timer); // Stop auto-hide timer
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 500);
              });
            }
          });
        });

        // --- Hamburger Menu Logic ---
        const navbarToggle = document.getElementById("navbar-toggle");
        const navbarLinks = document.getElementById("navbar-links");
        const menuOverlay = document.getElementById("mobile-menu-overlay");

        if (navbarToggle) {
          navbarToggle.addEventListener("click", () => {
            navbarLinks.classList.toggle("active");
            menuOverlay.classList.toggle("active");
            document.body.classList.toggle("menu-open");
          });

          menuOverlay.addEventListener("click", () => {
            navbarLinks.classList.remove("active");
            menuOverlay.classList.remove("active");
            document.body.classList.remove("menu-open");
          });
        }
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", () => {
            navigator.serviceWorker
              .register("{{ url_for('static', filename='service-worker.js') }}")
              .then((registration) => {
                console.log(
                  "ServiceWorker registration successful with scope: ",
                  registration.scope
                );
              })
              .catch((error) => {
                console.log("ServiceWorker registration failed: ", error);
              });
          });
        }


        function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
              outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
      }


      async function subscribeUser() {
          if ('serviceWorker' in navigator && 'PushManager' in window) {
              try {
                  const registration = await navigator.serviceWorker.ready;
                  let subscription = await registration.pushManager.getSubscription();

                  if (subscription === null) {
                      // Get VAPID public key from our server
                      const response = await fetch('/api/vapid_public_key');
                      const data = await response.json();
                      const vapidPublicKey = data.public_key;
                      const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

                      subscription = await registration.pushManager.subscribe({
                          userVisibleOnly: true,
                          applicationServerKey: convertedVapidKey
                      });
                  }

                  // Send the subscription object to our backend
                  await fetch('/api/subscribe', {
                      method: 'POST',
                      body: JSON.stringify(subscription),
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': '{{ csrf_token() }}' // For CSRF protection
                      }
                  });
                  console.log('User is subscribed.');

              } catch (error) {
                  console.error('Failed to subscribe the user: ', error);
              }
          }
      }

      // Ask for permission when a user is logged in
      {% if current_user.is_authenticated %}
          if (Notification.permission === 'default') {
              // You can trigger this on a button click for better UX
              Notification.requestPermission().then(permission => {
                  if (permission === 'granted') {
                      subscribeUser();
                  }
              });
          } else if (Notification.permission === 'granted') {
              subscribeUser();
          }
      {% endif %}
    </script>
  </body>
</html>
