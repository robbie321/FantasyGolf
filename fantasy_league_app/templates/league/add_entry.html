{% extends 'base.html' %} {% block content %}
<div class="picker-wrapper">
  <div class="picker-header">
    <h2>Create Your Team</h2>
    <p>You are joining: <strong>{{ league.name }}</strong></p>
  </div>

  <form
    id="add-entry-form"
    class="add-entry-league-form"
    action="{{ url_for('league.add_entry', league_id=league.id) }}"
    method="POST"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input
      type="hidden"
      id="player1_id"
      name="player1_id"
      value="{{ entry.player1_id or '' }}"
    />
    <input
      type="hidden"
      id="player2_id"
      name="player2_id"
      value="{{ entry.player2_id or '' }}"
    />
    <input
      type="hidden"
      id="player3_id"
      name="player3_id"
      value="{{ entry.player3_id or '' }}"
    />

    <div class="player-picks-container">
      <div class="player-slot" data-slot="1">
        <div class="player-slot-icon">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 4V20M4 12H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>
        <span class="player-slot-text">Add Player</span>
      </div>
      <div class="player-slot" data-slot="2">
        <div class="player-slot-icon">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 4V20M4 12H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>
        <span class="player-slot-text">Add Player</span>
      </div>
      <div class="player-slot" data-slot="3">
        <div class="player-slot-icon">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 4V20M4 12H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>
        <span class="player-slot-text">Add Player</span>
      </div>
    </div>

    <div class="summary-section">
      <h3>Tie-Breaker Question</h3>
      <p>{{ league.tie_breaker_question }}</p>
      <div class="form-group">
        <label for="tie_breaker_answer" style="display: none"
          >Your Answer</label
        >
        <input
          type="number"
          id="tie_breaker_answer"
          name="tie_breaker_answer"
          class="form-input"
          value="{{ entry.tie_breaker_answer or '' }}"
          placeholder="Enter your guess"
          required
        />
      </div>
    </div>

    <div class="summary-section">
      <div class="odds-row">
        <span class="odds-label">Total Combined Odds:</span>
        <span id="total-odds" class="odds-value">0</span>
      </div>
      <div class="odds-row">
        <span class="odds-label">League Odds Limit:</span>
        <span class="odds-value">{{ league.odds_limit }}</span>
      </div>
    </div>

    <button
      type="submit"
      id="save-btn"
      class="btn btn-primary save-btn"
      style="width: 100%"
    >
      Submit Entry
    </button>
  </form>
</div>

<div class="popup-overlay" id="player-list-overlay">
  <div class="popup-container">
    <div class="popup-header">
      <h3>Select a Player</h3>
      <button class="popup-close" id="popup-close-btn">&times;</button>
    </div>
    <div class="popup-body" id="player-list-body"></div>
  </div>
</div>

<script>
  // This JavaScript is identical to the 'edit_entry.html' script.
  // It handles the player selection popup, odds calculation, and button state.
  document.addEventListener('DOMContentLoaded', () => {
      const availablePlayers = {{ available_players|tojson }};
      const leagueOddsLimit = {{ league.odds_limit }};
      const playerSlots = document.querySelectorAll('.player-slot');
      const playerListOverlay = document.getElementById('player-list-overlay');
      const playerListBody = document.getElementById('player-list-body');
      const popupCloseBtn = document.getElementById('popup-close-btn');
      const totalOddsEl = document.getElementById('total-odds');
      const saveBtn = document.getElementById('save-btn');
      let activeSlot = null;
      let selectedPlayers = {};

      function updateOdds() {
          let total = 0;
          for (const slot in selectedPlayers) {
              total += selectedPlayers[slot].odds;
          }
          totalOddsEl.textContent = total;

          if (total >= leagueOddsLimit) {
              totalOddsEl.classList.remove('invalid');
              saveBtn.disabled = false;
          } else {
              totalOddsEl.classList.add('invalid');
              saveBtn.disabled = true;
          }
      }

      function openPlayerList(slotElement) {
          activeSlot = slotElement.dataset.slot;
          renderPlayerList();
          playerListOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
      }

      function closePlayerList() {
          playerListOverlay.classList.remove('active');
          document.body.style.overflow = 'auto';
      }

      function getSelectedPlayerIds() {
          return Object.values(selectedPlayers).map(p => p.id);
      }

      function renderPlayerList() {
          const selectedIds = getSelectedPlayerIds();
          let tableHtml = '<table class="player-list-table"><tbody>';
          availablePlayers.forEach(player => {
              if (!selectedIds.includes(player.id)) {
                  tableHtml += `
                      <tr>
                          <td><strong>${player.name} ${player.surname}</strong></td>
                          <td>${player.odds}</td>
                          <td>
                              <button type="button" class="add-player-btn" data-player-id="${player.id}">+</button>
                          </td>
                      </tr>`;
              }
          });
          tableHtml += '</tbody></table>';
          playerListBody.innerHTML = tableHtml;
      }

      function selectPlayer(playerId) {
          const player = availablePlayers.find(p => p.id == playerId);
          if (!player) return;

          selectedPlayers[activeSlot] = player;
          document.getElementById(`player${activeSlot}_id`).value = playerId;

          const slotDiv = document.querySelector(`.player-slot[data-slot="${activeSlot}"]`);
          slotDiv.innerHTML = `
              <div class="player-odds-bubble">${player.odds}</div>
              <div class="player-info">
                  <h4>${player.name} ${player.surname}</h4>
              </div>
          `;
          slotDiv.classList.remove('empty');

          updateOdds();
          closePlayerList();
      }

      playerSlots.forEach(slot => {
          slot.classList.add('empty');
          slot.addEventListener('click', () => openPlayerList(slot));
      });

      popupCloseBtn.addEventListener('click', closePlayerList);
      playerListOverlay.addEventListener('click', (e) => {
          if (e.target === playerListOverlay) closePlayerList();
      });

      playerListBody.addEventListener('click', (e) => {
          if (e.target.classList.contains('add-player-btn')) {
              selectPlayer(e.target.dataset.playerId);
          }
      });

      updateOdds(); // Initial check
  });
</script>
{% endblock %}
