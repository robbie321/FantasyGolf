{% extends 'base.html' %} {% block content %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaderboard - Fantasy Golf</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main id="leaderboard-page" class="page-container">
      <a href="#" class="back-link"><i class="fa-solid fa-arrow-left"></i></a>
      <div class="page-header">
        <h1>OMEGA European Masters <span class="tag tag-live">Live</span></h1>
        <p class="subtitle">Your total score: 258.0</p>
      </div>

      <section class="my-team-section">
        <h3>My Team</h3>
        <div class="team-display-grid">
          <div class="player-card">
            <div class="player-image-placeholder">
              <i class="fa-regular fa-image"></i>
            </div>
            <p>Matt Fitzpatrick</p>
            <span class="player-badge">9</span>
          </div>
          <div class="player-card">
            <div class="player-image-placeholder">
              <i class="fa-regular fa-image"></i>
            </div>
            <p>Wyndham Clark</p>
            <span class="player-badge">23</span>
          </div>
          <div class="player-card">
            <div class="player-image-placeholder">
              <i class="fa-regular fa-image"></i>
            </div>
            <p>Clement Sordet</p>
            <span class="player-badge high-score">226</span>
          </div>
        </div>
      </section>

      <details class="leaderboard-details">
        <summary>
          View league details <i class="fa-solid fa-chevron-down"></i>
        </summary>
        <div class="details-content">
          <p>More league details would go here...</p>
        </div>
      </details>

      <div class="leaderboard-table-container">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>RANK</th>
              <th>ENTRY NAME</th>
              <th class="text-right">TOTAL SCORE</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Rob Malone</td>
              <td class="text-right score-under">-7</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Sam M</td>
              <td class="text-right score-under">-3</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Reuben Holden</td>
              <td class="text-right score-under">-2</td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="btn btn-primary">View live leaderboard</button>
    </main>

  </body>
    <script src="script.js"></script>

  <!-- <script>
    // A SINGLE LISTENER FOR THE ENTIRE PAGE
    document.addEventListener("DOMContentLoaded", function () {
      console.log("DOM fully loaded. Starting script.");

      const profilePanel = document.getElementById("player-profile-panel");
      const panelBody = document.getElementById("profile-panel-body");
      const panelCloseBtn = document.getElementById("panel-close-btn");
      const slideInOverlay = document.getElementById("slide-in-overlay");

      const openProfilePanel = () => {
        profilePanel.classList.add("is-open");
        slideInOverlay.classList.add("is-open");
        document.body.style.overflow = "hidden"; // Prevent background scroll
      };

      const closeProfilePanel = () => {
        profilePanel.classList.remove("is-open");
        slideInOverlay.classList.remove("is-open");
        document.body.style.overflow = "";
      };

      // Add click listeners to all player name links
      document.querySelectorAll(".player-name-link").forEach((link) => {
        link.addEventListener("click", async (e) => {
          e.preventDefault();
          const playerId = link.dataset.playerId;

          // Show panel with a loading state
          panelBody.innerHTML = "<p>Loading player data...</p>";
          openProfilePanel();

          try {
            const response = await fetch(
              `/player/api/sportradar_profile_by_name/${playerId}`
            );
            if (!response.ok) {
              throw new Error("Player data not found.");
            }
            const data = await response.json();

            // Populate the panel with the fetched data
            panelBody.innerHTML = `
        <div class="profile-card">
          <img src="${data.headshot_url}" alt="Headshot of ${
              data.full_name
            }" class="profile-headshot">
          <h2>${data.full_name}</h2>
          <p class="country">${data.country}</p>
          <div class="profile-stats-grid">
            <div class="stat-item">
              <span class="label">Birthday</span>
              <span class="value">${data.birthday || "N/A"}</span>
            </div>
            <div class="stat-item">
              <span class="label">Turned Pro</span>
              <span class="value">${data.turned_pro || "N/A"}</span>
            </div>
            <div class="stat-item">
              <span class="label">Height</span>
              <span class="value">${data.height || "N/A"} in</span>
            </div>
            <div class="stat-item">
              <span class="label">Weight</span>
              <span class="value">${data.weight || "N/A"} lbs</span>
            </div>
          </div>
        </div>
      `;
          } catch (error) {
            panelBody.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
          }
        });
      });

      panelCloseBtn.addEventListener("click", closeProfilePanel);
      slideInOverlay.addEventListener("click", closeProfilePanel);



      // --- Player Stats Modal Logic ---
      const modal = document.getElementById("playerStatsModal");
      const closeBtn = document.querySelector(".modal .close-btn");
      const modalPlayerName = document.getElementById("modalPlayerName");
      const modalPlayerStats = document.getElementById("modalPlayerStats");

      const closeModal = () => {
        if (modal) modal.style.display = "none";
      };
      if (closeBtn) closeBtn.onclick = closeModal;
      window.onclick = (event) => {
        if (event.target == modal) closeModal();
      };

      // --- Collapsible Details Logic ---
      console.log("Setting up collapsible details..."); // Log #1
      const toggleButton = document.getElementById("details-toggle");
      const content = document.getElementById("details-content");

      // Log #2: Check if the button and content elements were found
      console.log("Toggle Button element:", toggleButton);
      console.log("Content Div element:", content);
      const buttonText = toggleButton.querySelector("span");
      const buttonArrow = toggleButton.querySelector(".arrow");

      if (toggleButton && content) {
        // Log #3: Confirm that the elements were found and the listener will be attached
        console.log("Button and content found. Attaching click listener...");

        toggleButton.addEventListener("click", function () {
          // Log #4: This will appear ONLY when the button is successfully clicked
          console.log("Details button CLICKED!");

          const isExpanded =
            toggleButton.getAttribute("aria-expanded") === "true";
          toggleButton.setAttribute("aria-expanded", !isExpanded);
          content.hidden = isExpanded;

          // Log #5: Check the state after the click
          console.log(`Content is now hidden: ${isExpanded}`);
        });
      } else {
        // Log #6: This will show if one or both elements are missing
        console.error(
          "CRITICAL: Could not find the toggle button or the content div."
        );
      }

      if (toggleButton) {
        toggleButton.addEventListener("click", function () {
          // Check if the content is currently open
          const isOpen =
            content.style.maxHeight && content.style.maxHeight !== "0px";

          if (isOpen) {
            content.style.maxHeight = "0px";
            buttonText.textContent = "View league details";
            buttonArrow.style.transform = "rotate(0deg)";
          } else {
            // Set max-height to the content's scroll height to make it expand
            content.style.maxHeight = content.scrollHeight + "px";
            buttonText.textContent = "Hide league details";
            buttonArrow.style.transform = "rotate(180deg)";
          }
        });
      }

      // --- Live Tournament Leaderboard Popup Logic ---
      const viewBtn = document.getElementById("view-live-leaderboard-btn");
      const overlay = document.getElementById("live-leaderboard-overlay");
      const modelCloseBtn = document.getElementById("popup-close-btn");
      const leaderboardBody = document.querySelector(
        "#live-leaderboard-body tbody"
      );

      const openPopup = () => overlay.classList.add("active");
      const closePopup = () => overlay.classList.remove("active");

      viewBtn.addEventListener("click", async () => {
        const tour = viewBtn.dataset.tour;
        leaderboardBody.innerHTML =
          '<tr><td colspan="3" style="text-align:center;">Loading...</td></tr>';
        openPopup();

        try {
          const response = await fetch(`/api/live-leaderboard/${tour}`);
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          const players = await response.json();

          leaderboardBody.innerHTML = ""; // Clear loading message

          if (players.length === 0) {
            leaderboardBody.innerHTML =
              '<tr><td colspan="3" style="text-align:center;">Live data not available for this tour.</td></tr>';
            return;
          }

          players.forEach((player) => {
            // --- Conditional Score Logic ---
            let scoreText = player.total;
            let rndScore = player.today;
            let scoreClass = "score-negative"; // Default to red for under par

            if (player.total === 0) {
              scoreText = "E";
              scoreClass = "score-even";
            } else if (player.total > 0) {
              scoreText = `+${player.total}`;
              scoreClass = "score-positive";
            }

            rndScore = player.today === 0 ? "E" : player.today;

            // Display 'F' if thru is 18, otherwise display the number
            const thruText = player.thru === 18 ? "F" : player.thru;

            const row = `
                          <tr>
                              <td class="pos">${player.current_pos}</td>
                              <td class="player-name">${player.player_name}</td>

                              <td style="text-align:center"> <span class="live-score ${scoreClass}">${player.current_score}</span></td>
                              <td style="text-align:center; font-weight:bold">${thruText}</td>
                              <td style="text-align:center; font-weight:bold; padding-right:8px">${rndScore}</td>
                          </tr>
                      `;
            leaderboardBody.insertAdjacentHTML("beforeend", row);
          });
        } catch (error) {
          console.error("Failed to fetch live leaderboard:", error);
          leaderboardBody.innerHTML =
            '<tr><td colspan="3" style="text-align:center;">Could not load live data.</td></tr>';
        }
      });

      modelCloseBtn.addEventListener("click", closePopup);
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) {
          closePopup();
        }
      });

      console.log("viewBtn element:", viewBtn);

      if (viewBtn) {
        console.log("Button found. Attaching click listener...");
        viewBtn.addEventListener("click", async () => {
          console.log("View Leaderboard button CLICKED!");
          fetch(`/league/api/${leagueId}/leaderboard`)
            .then((response) => response.json())
            .then((data) => {
              const leaderboardBody =
                document.getElementById("leaderboard-body");
              if (!leaderboardBody) return;
              leaderboardBody.innerHTML = "";
              if (data.length === 0) {
                leaderboardBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem;">No entries in this league yet.</td></tr>`;
                return;
              }
              let rank = 1;
              data.forEach((entry) => {
                const row = document.createElement("tr");
                if (entry.is_current_user) {
                  row.classList.add("my-entry");
                }

                leaderboardBody.appendChild(row);
                rank++;
              });
              setupModalEventListeners();
            })
            .catch((error) =>
              console.error("Error updating leaderboard:", error)
            );
        });
      } else {
        console.log("View Leaderboard button not found on this page.");
      }

      // --- NEW, UNIFIED SOCKET.IO LOGIC ---
      var socket = io();

      socket.on("connect", function () {
        console.log("Socket.IO connected!");
      });

      socket.on("scores_updated", function (data) {
        console.log(
          "Scores updated event received for tours:",
          data.updated_tours
        );
        var currentLeagueTour = "{{ league.tour }}";
        if (data.updated_tours.includes(currentLeagueTour)) {
          console.log("Leaderboard will refresh.");
          location.reload();
        }
      });

      // --- Collapsible Leaderboard Logic ---
      console.log("Setting up collapsible leaderboard..."); // Log #1
      const mainRows = document.querySelectorAll(".leaderboard-main-row");

      // Log #2: Check if any rows were found
      console.log(
        `Found ${mainRows.length} leaderboard rows to make clickable.`
      );

      mainRows.forEach((row) => {
        row.addEventListener("click", () => {
          // Log #3: Check if a click is registered
          console.log("A leaderboard row was clicked!");

          const targetId = row.dataset.target;
          // Log #4: Check if the data-target attribute is being read correctly
          console.log(`Target ID from data-target is: ${targetId}`);

          const detailsRow = document.querySelector(targetId);
          // Log #5: Check if the details row was found in the document
          console.log(
            "Found the corresponding details row element:",
            detailsRow
          );

          if (detailsRow) {
            // Log #6: Confirm that the class toggle is about to happen
            console.log("Toggling the 'is-open' class.");
            row.classList.toggle("is-open");
            detailsRow.classList.toggle("is-open");
          } else {
            console.error(
              "CRITICAL: Could not find the details row with selector:",
              targetId
            );
          }
        });
      });
    });
  </script> -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      console.log("DOM fully loaded. Starting all scripts.");

      // --- LOGIC 1: Countdown Timer ---
      const countdownElement = document.getElementById("countdown");
      if (countdownElement) {
        const deadline = new Date(
          countdownElement.dataset.deadline + "Z"
        ).getTime();
        const timer = setInterval(function () {
          const now = new Date().getTime();
          const distance = deadline - now;
          if (distance < 0) {
            clearInterval(timer);
            countdownElement.innerHTML =
              "<h3>The entry deadline has passed.</h3>";
            return;
          }
          const days = Math.floor(distance / (1000 * 60 * 60 * 24));
          const hours = Math.floor(
            (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
          );
          const minutes = Math.floor(
            (distance % (1000 * 60 * 60)) / (1000 * 60)
          );
          const seconds = Math.floor((distance % (1000 * 60)) / 1000);
          document.getElementById("days").innerText = String(days).padStart(
            2,
            "0"
          );
          document.getElementById("hours").innerText = String(hours).padStart(
            2,
            "0"
          );
          document.getElementById("minutes").innerText = String(
            minutes
          ).padStart(2, "0");
          document.getElementById("seconds").innerText = String(
            seconds
          ).padStart(2, "0");
        }, 1000);
      }

      // --- LOGIC 2: Player Profile Slide-In Panel ---
      const profilePanel = document.getElementById("player-profile-panel");
      if (profilePanel) {
        const panelBody = document.getElementById("profile-panel-body");
        const panelCloseBtn = document.getElementById("panel-close-btn");
        const slideInOverlay = document.getElementById("slide-in-overlay");

        const openProfilePanel = () => {
          profilePanel.classList.add("is-open");
          slideInOverlay.classList.add("is-open");
          document.body.style.overflow = "hidden";
        };
        const closeProfilePanel = () => {
          profilePanel.classList.remove("is-open");
          slideInOverlay.classList.remove("is-open");
          document.body.style.overflow = "";
        };

        document.querySelectorAll(".player-name-link").forEach((link) => {
          link.addEventListener("click", async (e) => {
            e.preventDefault();
            const playerId = link.dataset.playerId;

            // Show panel with a loading state
            panelBody.innerHTML = "<p>Loading player data...</p>";
            openProfilePanel();

            try {
              const response = await fetch(
                `/player/api/sportradar_profile_by_name/${playerId}`
              );
              if (!response.ok) {
                throw new Error("Player data not found.");
              }
              const data = await response.json();

              // Populate the panel with the fetched data
              panelBody.innerHTML = `
        <div class="profile-card">
          <img src="${data.headshot_url}" alt="Headshot of ${
                data.full_name
              }" class="profile-headshot">
          <h2>${data.full_name}</h2>
          <p class="country">${data.country}</p>
          <div class="profile-stats-grid">
            <div class="stat-item">
              <span class="label">Birthday</span>
              <span class="value">${data.birthday || "N/A"}</span>
            </div>
            <div class="stat-item">
              <span class="label">Turned Pro</span>
              <span class="value">${data.turned_pro || "N/A"}</span>
            </div>
            <div class="stat-item">
              <span class="label">Height</span>
              <span class="value">${data.height || "N/A"} in</span>
            </div>
            <div class="stat-item">
              <span class="label">Weight</span>
              <span class="value">${data.weight || "N/A"} lbs</span>
            </div>
          </div>
        </div>
      `;
            } catch (error) {
              panelBody.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
          });
        });
        panelCloseBtn.addEventListener("click", closeProfilePanel);
        slideInOverlay.addEventListener("click", closeProfilePanel);
      }

      // --- LOGIC 3: Live Tournament Leaderboard Popup ---
      const viewBtn = document.getElementById("view-live-leaderboard-btn");
      if (viewBtn) {
        // Define all elements related to the popup
        const overlay = document.getElementById("live-leaderboard-overlay");
        const closeBtn = document.getElementById("popup-close-btn");
        const leaderboardBody = document.querySelector(
          "#live-leaderboard-body .live-leaderboard-table tbody"
        );

        // Define the helper functions BEFORE they are used
        const openPopup = () => {
          if (overlay) overlay.classList.add("active");
        };
        const closePopup = () => {
          if (overlay) overlay.classList.remove("active");
        };

        // Attach the main event listener
        viewBtn.addEventListener("click", async () => {
          if (!leaderboardBody) return;

          leaderboardBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';
          openPopup(); // Now this function is defined and can be called

          try {
            const tour = viewBtn.dataset.tour;
            const response = await fetch(`/api/live-leaderboard/${tour}`);
            if (!response.ok) throw new Error("Network response was not ok");

            const players = await response.json();
            leaderboardBody.innerHTML = ""; // Clear loading message

            if (players.length === 0) {
              leaderboardBody.innerHTML =
                '<tr><td colspan="5" style="text-align:center;">Live data not available for this tour.</td></tr>';
              return;
            }

            players.forEach((player) => {
              // --- Conditional Score Logic ---
              let scoreText = player.total;
              let rndScore = player.today;
              let scoreClass = "score-negative"; // Default to red for under par

              if (player.total === 0) {
                scoreText = "E";
                scoreClass = "score-even";
              } else if (player.total > 0) {
                scoreText = `+${player.total}`;
                scoreClass = "score-positive";
              }

              rndScore = player.today === 0 ? "E" : player.today;

              // Display 'F' if thru is 18, otherwise display the number
              const thruText = player.thru === 18 ? "F" : player.thru;

              const row = `
                            <tr>
                                <td class="pos">${player.current_pos}</td>
                                <td class="player-name">${player.player_name}</td>

                                <td style="text-align:center"> <span class="live-score ${scoreClass}">${player.current_score}</span></td>
                                <td style="text-align:center; font-weight:bold">${thruText}</td>
                                <td style="text-align:center; font-weight:bold; padding-right:8px">${rndScore}</td>
                            </tr>
                        `;
              leaderboardBody.insertAdjacentHTML("beforeend", row);
            });
          } catch (error) {
            console.error("Failed to fetch live leaderboard:", error);
            leaderboardBody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;">Could not load live data.</td></tr>';
          }
        });

        // Attach listeners for closing the popup
        if (closeBtn) closeBtn.addEventListener("click", closePopup);
        if (overlay)
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closePopup();
          });
      }

      // --- LOGIC 4: Collapsible League Leaderboard Rows ---
      const mainRows = document.querySelectorAll(".leaderboard-main-row");
      mainRows.forEach((row) => {
        row.addEventListener("click", () => {
          const targetId = row.dataset.target;
          const detailsRow = document.querySelector(targetId);
          if (detailsRow) {
            row.classList.toggle("is-open");
            detailsRow.classList.toggle("is-open");
          }
        });
      });

      // --- LOGIC 5: Socket.IO for Live Page Reload ---
      var socket = io();
      socket.on("connect", function () {
        console.log("Socket.IO connected!");
      });
      socket.on("scores_updated", function (data) {
        var currentLeagueTour = "{{ league.tour }}";
        if (data.updated_tours.includes(currentLeagueTour)) {
          location.reload();
        }
      });

      // --- Collapsible Details Logic ---
      console.log("Setting up collapsible details..."); // Log #1
      const toggleButton = document.getElementById("details-toggle");
      const content = document.getElementById("details-content");

      // Log #2: Check if the button and content elements were found
      console.log("Toggle Button element:", toggleButton);
      console.log("Content Div element:", content);
      const buttonText = toggleButton.querySelector("span");
      const buttonArrow = toggleButton.querySelector(".arrow");

      if (toggleButton && content) {
        // Log #3: Confirm that the elements were found and the listener will be attached
        console.log("Button and content found. Attaching click listener...");

        toggleButton.addEventListener("click", function () {
          // Log #4: This will appear ONLY when the button is successfully clicked
          console.log("Details button CLICKED!");

          const isExpanded =
            toggleButton.getAttribute("aria-expanded") === "true";
          toggleButton.setAttribute("aria-expanded", !isExpanded);
          content.hidden = isExpanded;

          // Log #5: Check the state after the click
          console.log(`Content is now hidden: ${isExpanded}`);
        });
      } else {
        // Log #6: This will show if one or both elements are missing
        console.error(
          "CRITICAL: Could not find the toggle button or the content div."
        );
      }

      if (toggleButton) {
        toggleButton.addEventListener("click", function () {
          // Check if the content is currently open
          const isOpen =
            content.style.maxHeight && content.style.maxHeight !== "0px";

          if (isOpen) {
            content.style.maxHeight = "0px";
            buttonText.textContent = "View league details";
            buttonArrow.style.transform = "rotate(0deg)";
          } else {
            // Set max-height to the content's scroll height to make it expand
            content.style.maxHeight = content.scrollHeight + "px";
            buttonText.textContent = "Hide league details";
            buttonArrow.style.transform = "rotate(180deg)";
          }
        });
      }
    });
  </script>
</div>
{% endblock %}
