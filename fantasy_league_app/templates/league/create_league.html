{% extends 'base.html' %} {% from "_form_macros.html" import render_field %} {%
block head %}
<!-- Link to the form-specific stylesheet -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/form_style.css') }}"
/>

<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
  .template-selector-container {
    background: linear-gradient(135deg, #e8f5f1 0%, #f0f9f6 100%);
    border: 2px solid #00855f;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0, 133, 95, 0.1);
  }

  .template-selector-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: #00855f;
    margin-bottom: 1rem;
  }

  .template-selector-header i {
    font-size: 1.25rem;
  }

  #template-selector {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    border: 2px solid #00855f;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #template-selector:hover {
    border-color: #006b4d;
    box-shadow: 0 0 0 3px rgba(0, 133, 95, 0.1);
  }

  #template-selector:focus {
    outline: none;
    border-color: #006b4d;
    box-shadow: 0 0 0 4px rgba(0, 133, 95, 0.15);
  }

  .template-selector-container .form-text {
    color: #2d5f4f;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    font-style: italic;
  }
</style>
{% endblock %} {% block content %}
<main class="dashboard-content">
  <div class="form-wrapper">
    <a href="{{ url_for('main.club_dashboard') }}" class="back-link">
      <i class="fa-solid fa-arrow-left"></i>
      <span>Back to Club Dashboard</span>
    </a>
    <form
      method="POST"
      action="{{ url_for('league.create_league') }}"
      novalidate
    >
      {{ form.hidden_tag() }}

      <!-- League Information Section -->
      <section class="form-section">
        <div class="form-header">
          <h1>Create New League</h1>
          <p>Set up a new fantasy league for your club members.</p>
        </div>

        <!-- Template Selector -->
        <div class="template-selector-container">
          <div class="template-selector-header">
            <i class="fa-solid fa-layer-group"></i>
            <span>Start from a template</span>
          </div>
          <select id="template-selector" class="form-control">
            <option value="">Create from scratch</option>
          </select>
          <small class="form-text">Or fill in the form manually below</small>
        </div>

        <div class="form-section-header">
          <i class="fa-solid fa-trophy"></i>
          <div>
            <h2>League Information</h2>
            <p>Enter the basic details for your tournament.</p>
          </div>
        </div>
        <div class="form-group">{{ render_field(form.name) }}</div>
        <div class="form-grid two-col">
          <div class="form-group">{{ render_field(form.tour) }}</div>
          <div class="form-group">
            {{ render_field(form.player_bucket_id, class="form-control") }}
          </div>
        </div>
        <div id="tournament-details-container" class="tournament-details"></div>
      </section>

      <!-- Financial Settings Section -->
      <section class="form-section">
        <div class="form-section-header">
          <i class="fa-solid fa-dollar-sign"></i>
          <div>
            <h2>Financial Settings</h2>
            <p>Configure entry fees and tournament rules.</p>
          </div>
        </div>
        <div class="form-grid two-col">
          <div class="form-group">{{ render_field(form.entry_fee) }}</div>
          <div class="form-group">{{ render_field(form.max_entries) }}</div>
          <div class="form-group">{{ render_field(form.prize_amount) }}</div>
          <div class="form-group">{{ render_field(form.odds_limit) }}</div>
        </div>
      </section>

      <!-- League Rules & Details Section -->
      <section class="form-section">
        <div class="form-section-header">
          <i class="fa-solid fa-gavel"></i>
          <div>
            <h2>League Rules & Details</h2>
            <p>Add custom rules and define the prize structure.</p>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="prize_details">
              {{ form.prize_details.label }}
            </label>
            <div id="prize-details-editor" style="height: 150px; background: white; border: 1px solid #ddd; border-radius: 4px;"></div>
            <input type="hidden" id="prize_details" name="prize_details" value="{{ form.prize_details.data or '' }}" />
            <small class="form-text">Add details about prizes, vouchers, pro shop credits, etc.</small>
          </div>
          <div class="form-group">
            <label for="rules">
              {{ form.rules.label }}
            </label>
            <div id="rules-editor" style="height: 150px; background: white; border: 1px solid #ddd; border-radius: 4px;"></div>
            <input type="hidden" id="rules" name="rules" value="{{ form.rules.data or '' }}" />
            <small class="form-text">Format your league rules with bullets, bold, italics, etc.</small>
          </div>
          <div class="toggle-switch">
            <div class="label-group">
              <label for="no_favorites_rule">Enforce No Favorites Rule</label>
              <p>Prevents players from selecting highly favored golfers.</p>
            </div>
            {{ form.no_favorites_rule() }}
          </div>
        </div>
        <div class="form-actions">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </section>
    </form>
  </div>
</main>

<script>
  let rulesEditor = null;
  let prizeDetailsEditor = null;

  document.addEventListener("DOMContentLoaded", function () {
    const playerBucketSelect = document.getElementById("player_bucket_id");
    const tourSelect = document.getElementById("tour");
    const templateSelector = document.getElementById("template-selector");

    // Initialize Quill editor for prize details
    prizeDetailsEditor = new Quill('#prize-details-editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['clean']
        ]
      },
      placeholder: 'Enter prize details here...'
    });

    // Initialize Quill editor for rules
    rulesEditor = new Quill('#rules-editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['clean']
        ]
      },
      placeholder: 'Enter league rules here...'
    });

    // Load existing content if editing
    const existingPrizeDetails = document.getElementById('prize_details').value;
    if (existingPrizeDetails) {
      prizeDetailsEditor.root.innerHTML = existingPrizeDetails;
    }

    const existingRules = document.getElementById('rules').value;
    if (existingRules) {
      rulesEditor.root.innerHTML = existingRules;
    }

    // Update hidden inputs on form submission
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const prizeHTML = prizeDetailsEditor.root.innerHTML;
        document.getElementById('prize_details').value = prizeHTML;

        const rulesHTML = rulesEditor.root.innerHTML;
        document.getElementById('rules').value = rulesHTML;
      });
    }

    // Load templates for the selector
    async function loadTemplateOptions() {
      try {
        const response = await fetch('/api/templates');
        const templates = await response.json();

        templates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          const maxEntriesText = template.max_entries ? `${template.max_entries} entries` : 'Unlimited';
          option.textContent = `${template.name} (€${template.entry_fee} - ${maxEntriesText})`;
          templateSelector.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load templates:', error);
      }
    }

    // Apply template to form
    async function applyTemplate(templateId) {
      if (!templateId) return;

      try {
        const response = await fetch(`/api/templates/${templateId}`);
        const template = await response.json();

        // Update form fields with template values
        const entryFeeField = document.getElementById('entry_fee');
        if (entryFeeField) {
          entryFeeField.value = template.entry_fee;
        }

        const maxEntriesField = document.getElementById('max_entries');
        if (maxEntriesField && template.max_entries) {
          maxEntriesField.value = template.max_entries;
        }

        // Update prize details with HTML from template (load directly into Quill editor)
        if (prizeDetailsEditor && template.prize_details) {
          prizeDetailsEditor.root.innerHTML = template.prize_details;
        }

        // Update rules field with HTML from template (load directly into Quill editor)
        if (rulesEditor && template.rules) {
          rulesEditor.root.innerHTML = template.rules;
        }

        // Increment template usage counter
        await fetch(`/api/templates/${templateId}/use`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
          }
        });

        alert(`Template "${template.name}" applied successfully! Other fields like tour and bucket selection are ready for you to fill in.`);
      } catch (error) {
        console.error('Failed to apply template:', error);
        alert('Failed to load template. Please try again.');
      }
    }

    // Template selector change handler
    if (templateSelector) {
      templateSelector.addEventListener('change', (e) => {
        const templateId = e.target.value;
        if (templateId) {
          applyTemplate(templateId);
        }
      });

      // Load templates on page load
      loadTemplateOptions();
    }

    if (playerBucketSelect && tourSelect) {
      playerBucketSelect.addEventListener("change", function () {
        const bucketId = this.value;

        // Make sure the user has selected a valid bucket
        if (bucketId) {
          // Fetch the tour from our new API endpoint
          fetch(`/get-tour-for-bucket/${bucketId}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              if (data.tour) {
                // Update the 'Tour' dropdown to the correct value
                tourSelect.value = data.tour;
              }
            })
            .catch((error) => {
              console.error("Error fetching tour for bucket:", error);
            });
        }
      });
    }

    const detailsContainer = document.getElementById(
      "tournament-details-container"
    );

    if (playerBucketSelect) {
      playerBucketSelect.addEventListener("change", function () {
        const bucketId = this.value;
        detailsContainer.innerHTML = "";
        detailsContainer.classList.remove("visible");

        if (!bucketId) return;

        detailsContainer.innerHTML = "<p>Fetching tournament info...</p>";
        detailsContainer.classList.add("visible");

        fetch(`/api/tournament-details/${bucketId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              detailsContainer.innerHTML = `<p class="error">${data.error}</p>`;
            } else {
              detailsContainer.innerHTML = `
                            <div class="detail-item">
                                <strong>Tournament:</strong> ${data.event_name}
                            </div>
                            <div class="detail-item">
                                <strong>Start Date:</strong> ${data.start_date}
                            </div>
                            <div class="detail-item">
                                <strong>First Tee Time (R1):</strong> ${data.tee_time}
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("Error fetching tournament details:", error);
            detailsContainer.innerHTML =
              '<p class="error">Could not load tournament details.</p>';
          });
      });
    }
  });
  function validateFee(input) {
    const warning = document.getElementById("fee-warning");
    const value = parseFloat(input.value);
    if (value > 0 && value < 5) {
      warning.style.display = "block";
    } else {
      warning.style.display = "none";
    }
  }
</script>
{% endblock %}
