{% extends 'base.html' %} {% from "_form_macros.html" import render_field %} {%
block head %}
<!-- Link to the form-specific stylesheet -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/form_style.css') }}"
/>
{% endblock %} {% block content %}
<main class="dashboard-content">
  <div class="form-wrapper">
    <a href="{{ url_for('main.club_dashboard') }}" class="back-link">
      <i class="fa-solid fa-arrow-left"></i>
      <span>Back to Club Dashboard</span>
    </a>
    <form
      method="POST"
      action="{{ url_for('league.create_league') }}"
      novalidate
    >
      {{ form.hidden_tag() }}

      <!-- League Information Section -->
      <section class="form-section">
        <div class="form-header">
          <h1>Create New League</h1>
          <p>Set up a new fantasy league for your club members.</p>
        </div>
        <div class="form-section-header">
          <i class="fa-solid fa-trophy"></i>
          <div>
            <h2>League Information</h2>
            <p>Enter the basic details for your tournament.</p>
          </div>
        </div>
        <div class="form-group">{{ render_field(form.name) }}</div>
        <div class="form-grid two-col">
          <div class="form-group">{{ render_field(form.tour) }}</div>
          <div class="form-group">
            {{ render_field(form.player_bucket_id, class="form-control") }}
          </div>
        </div>
        <div id="tournament-details-container" class="tournament-details"></div>
      </section>

      <!-- Financial Settings Section -->
      <section class="form-section">
        <div class="form-section-header">
          <i class="fa-solid fa-dollar-sign"></i>
          <div>
            <h2>Financial Settings</h2>
            <p>Configure entry fees and tournament rules.</p>
          </div>
        </div>
        <div class="form-grid two-col">
          <div class="form-group">{{ render_field(form.entry_fee) }}</div>
          <div class="form-group">{{ render_field(form.max_entries) }}</div>
          <div class="form-group">{{ render_field(form.prize_amount) }}</div>
          <div class="form-group">{{ render_field(form.odds_limit) }}</div>
        </div>
      </section>

      <!-- League Rules & Details Section -->
      <section class="form-section">
        <div class="form-section-header">
          <i class="fa-solid fa-gavel"></i>
          <div>
            <h2>League Rules & Details</h2>
            <p>Add custom rules and define the prize structure.</p>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            {{ render_field(form.prize_details, rows="4") }}
          </div>
          <div class="form-group">{{ render_field(form.rules, rows="4") }}</div>
          <div class="toggle-switch">
            <div class="label-group">
              <label for="no_favorites_rule">Enforce No Favorites Rule</label>
              <p>Prevents players from selecting highly favored golfers.</p>
            </div>
            {{ form.no_favorites_rule() }}
          </div>
        </div>
        <div class="form-actions">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </section>
    </form>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const playerBucketSelect = document.getElementById("player_bucket_id");
    const tourSelect = document.getElementById("tour");

    if (playerBucketSelect && tourSelect) {
      playerBucketSelect.addEventListener("change", function () {
        const bucketId = this.value;

        // Make sure the user has selected a valid bucket
        if (bucketId) {
          // Fetch the tour from our new API endpoint
          fetch(`/get-tour-for-bucket/${bucketId}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              if (data.tour) {
                // Update the 'Tour' dropdown to the correct value
                tourSelect.value = data.tour;
              }
            })
            .catch((error) => {
              console.error("Error fetching tour for bucket:", error);
            });
        }
      });
    }

    const detailsContainer = document.getElementById(
      "tournament-details-container"
    );

    if (playerBucketSelect) {
      playerBucketSelect.addEventListener("change", function () {
        const bucketId = this.value;
        detailsContainer.innerHTML = "";
        detailsContainer.classList.remove("visible");

        if (!bucketId) return;

        detailsContainer.innerHTML = "<p>Fetching tournament info...</p>";
        detailsContainer.classList.add("visible");

        fetch(`/api/tournament-details/${bucketId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              detailsContainer.innerHTML = `<p class="error">${data.error}</p>`;
            } else {
              detailsContainer.innerHTML = `
                            <div class="detail-item">
                                <strong>Tournament:</strong> ${data.event_name}
                            </div>
                            <div class="detail-item">
                                <strong>Start Date:</strong> ${data.start_date}
                            </div>
                            <div class="detail-item">
                                <strong>First Tee Time (R1):</strong> ${data.tee_time}
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("Error fetching tournament details:", error);
            detailsContainer.innerHTML =
              '<p class="error">Could not load tournament details.</p>';
          });
      });
    }
  });
  function validateFee(input) {
    const warning = document.getElementById("fee-warning");
    const value = parseFloat(input.value);
    if (value > 0 && value < 5) {
      warning.style.display = "block";
    } else {
      warning.style.display = "none";
    }
  }
</script>
{% endblock %}
