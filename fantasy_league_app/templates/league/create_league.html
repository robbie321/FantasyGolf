{% extends 'base.html' %} {% from "_form_macros.html" import render_field %} {%
block head %}
<!-- Link to the form-specific stylesheet -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/form_style.css') }}"
/>
<style>
  .template-selector-container {
    background: linear-gradient(135deg, #e8f5f1 0%, #f0f9f6 100%);
    border: 2px solid #00855f;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0, 133, 95, 0.1);
  }

  .template-selector-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: #00855f;
    margin-bottom: 1rem;
  }

  .template-selector-header i {
    font-size: 1.25rem;
  }

  #template-selector {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    border: 2px solid #00855f;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #template-selector:hover {
    border-color: #006b4d;
    box-shadow: 0 0 0 3px rgba(0, 133, 95, 0.1);
  }

  #template-selector:focus {
    outline: none;
    border-color: #006b4d;
    box-shadow: 0 0 0 4px rgba(0, 133, 95, 0.15);
  }

  .template-selector-container .form-text {
    color: #2d5f4f;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    font-style: italic;
  }
</style>
{% endblock %} {% block content %}
<main class="dashboard-content">
  <div class="form-wrapper">
    <a href="{{ url_for('main.club_dashboard') }}" class="back-link">
      <i class="fa-solid fa-arrow-left"></i>
      <span>Back to Club Dashboard</span>
    </a>
    <form
      method="POST"
      action="{{ url_for('league.create_league') }}"
      novalidate
    >
      {{ form.hidden_tag() }}

      <!-- League Information Section -->
      <section class="form-section">
        <div class="form-header">
          <h1>Create New League</h1>
          <p>Set up a new fantasy league for your club members.</p>
        </div>

        <!-- Template Selector -->
        <div class="template-selector-container">
          <div class="template-selector-header">
            <i class="fa-solid fa-layer-group"></i>
            <span>Start from a template</span>
          </div>
          <select id="template-selector" class="form-control">
            <option value="">Create from scratch</option>
          </select>
          <small class="form-text">Or fill in the form manually below</small>
        </div>

        <div class="form-section-header">
          <i class="fa-solid fa-trophy"></i>
          <div>
            <h2>League Information</h2>
            <p>Enter the basic details for your tournament.</p>
          </div>
        </div>
        <div class="form-group">{{ render_field(form.name) }}</div>
        <div class="form-grid two-col">
          <div class="form-group">{{ render_field(form.tour) }}</div>
          <div class="form-group">
            {{ render_field(form.player_bucket_id, class="form-control") }}
          </div>
        </div>
        <div id="tournament-details-container" class="tournament-details"></div>
      </section>

      <!-- Financial Settings Section -->
      <section class="form-section">
        <div class="form-section-header">
          <i class="fa-solid fa-dollar-sign"></i>
          <div>
            <h2>Financial Settings</h2>
            <p>Configure entry fees and tournament rules.</p>
          </div>
        </div>
        <div class="form-grid two-col">
          <div class="form-group">{{ render_field(form.entry_fee) }}</div>
          <div class="form-group">{{ render_field(form.max_entries) }}</div>
          <div class="form-group">{{ render_field(form.prize_amount) }}</div>
          <div class="form-group">{{ render_field(form.odds_limit) }}</div>
        </div>
      </section>

      <!-- League Rules & Details Section -->
      <section class="form-section">
        <div class="form-section-header">
          <i class="fa-solid fa-gavel"></i>
          <div>
            <h2>League Rules & Details</h2>
            <p>Add custom rules and define the prize structure.</p>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            {{ render_field(form.prize_details, rows="4") }}
          </div>
          <div class="form-group">{{ render_field(form.rules, rows="4") }}</div>
          <div class="toggle-switch">
            <div class="label-group">
              <label for="no_favorites_rule">Enforce No Favorites Rule</label>
              <p>Prevents players from selecting highly favored golfers.</p>
            </div>
            {{ form.no_favorites_rule() }}
          </div>
        </div>
        <div class="form-actions">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </section>
    </form>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const playerBucketSelect = document.getElementById("player_bucket_id");
    const tourSelect = document.getElementById("tour");
    const templateSelector = document.getElementById("template-selector");

    // Load templates for the selector
    async function loadTemplateOptions() {
      try {
        const response = await fetch('/api/templates');
        const templates = await response.json();

        templates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          option.textContent = `${template.name} (${template.tour} - €${template.entry_fee})`;
          templateSelector.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load templates:', error);
      }
    }

    // Apply template to form
    async function applyTemplate(templateId) {
      if (!templateId) return;

      try {
        const response = await fetch(`/api/templates/${templateId}`);
        const template = await response.json();

        // Update form fields
        document.getElementById('tour').value = template.tour;
        document.getElementById('entry_fee').value = template.entry_fee;
        if (template.max_entries && document.getElementById('max_entries')) {
          document.getElementById('max_entries').value = template.max_entries;
        }

        // Update bucket picks if these fields exist
        const bucketFields = {
          'bucket_a_picks': template.bucket_picks.a,
          'bucket_b_picks': template.bucket_picks.b,
          'bucket_c_picks': template.bucket_picks.c,
          'bucket_d_picks': template.bucket_picks.d,
          'bucket_e_picks': template.bucket_picks.e
        };

        Object.keys(bucketFields).forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.value = bucketFields[fieldId];
          }
        });

        // Update checkboxes if they exist
        const publicLeagueCheckbox = document.getElementById('is_public');
        if (publicLeagueCheckbox) {
          publicLeagueCheckbox.checked = template.is_public;
        }

        const requirePaymentCheckbox = document.getElementById('require_payment');
        if (requirePaymentCheckbox) {
          requirePaymentCheckbox.checked = template.require_payment;
        }

        // Update tiebreaker question
        const tiebreakerField = document.getElementById('tiebreaker_question');
        if (tiebreakerField && template.tiebreaker_question) {
          tiebreakerField.value = template.tiebreaker_question;
        }

        // Increment usage counter
        fetch(`/api/templates/${templateId}/use`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
          }
        });

        alert(`Template "${template.name}" applied successfully!`);
      } catch (error) {
        console.error('Failed to apply template:', error);
        alert('Failed to load template. Please try again.');
      }
    }

    // Template selector change handler
    if (templateSelector) {
      templateSelector.addEventListener('change', (e) => {
        const templateId = e.target.value;
        if (templateId) {
          applyTemplate(templateId);
        }
      });

      // Load templates on page load
      loadTemplateOptions();
    }

    if (playerBucketSelect && tourSelect) {
      playerBucketSelect.addEventListener("change", function () {
        const bucketId = this.value;

        // Make sure the user has selected a valid bucket
        if (bucketId) {
          // Fetch the tour from our new API endpoint
          fetch(`/get-tour-for-bucket/${bucketId}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              if (data.tour) {
                // Update the 'Tour' dropdown to the correct value
                tourSelect.value = data.tour;
              }
            })
            .catch((error) => {
              console.error("Error fetching tour for bucket:", error);
            });
        }
      });
    }

    const detailsContainer = document.getElementById(
      "tournament-details-container"
    );

    if (playerBucketSelect) {
      playerBucketSelect.addEventListener("change", function () {
        const bucketId = this.value;
        detailsContainer.innerHTML = "";
        detailsContainer.classList.remove("visible");

        if (!bucketId) return;

        detailsContainer.innerHTML = "<p>Fetching tournament info...</p>";
        detailsContainer.classList.add("visible");

        fetch(`/api/tournament-details/${bucketId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              detailsContainer.innerHTML = `<p class="error">${data.error}</p>`;
            } else {
              detailsContainer.innerHTML = `
                            <div class="detail-item">
                                <strong>Tournament:</strong> ${data.event_name}
                            </div>
                            <div class="detail-item">
                                <strong>Start Date:</strong> ${data.start_date}
                            </div>
                            <div class="detail-item">
                                <strong>First Tee Time (R1):</strong> ${data.tee_time}
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("Error fetching tournament details:", error);
            detailsContainer.innerHTML =
              '<p class="error">Could not load tournament details.</p>';
          });
      });
    }
  });
  function validateFee(input) {
    const warning = document.getElementById("fee-warning");
    const value = parseFloat(input.value);
    if (value > 0 && value < 5) {
      warning.style.display = "block";
    } else {
      warning.style.display = "none";
    }
  }
</script>
{% endblock %}
