{% extends 'base.html' %} {% block content %}
<!-- <style>
  /* --- Main Page Layout --- */

  .league-container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
  }
  .back-to-dashboard {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: #333;
    margin-bottom: 1.5rem;
    font-weight: bold;
  }
  .content-box {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 2rem 3rem;
  }

  /* --- Winner Banner --- */
  .winner-banner {
    background-color: #ffc72c;
    color: #333;
    text-align: center;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2.5rem;
  }
  .winner-banner h2 {
    color: darkgreen;
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
  }
  .winner-banner p {
    margin: 0;
    font-size: 1.2rem;
    font-weight: bold;
  }
  .winner-banner a {
    color: darkgreen;
    text-decoration: none;
  }
  .winner-banner a:hover {
    text-decoration: underline;
  }

  /* --- League Header --- */
  .league-header {
    text-align: center;
    padding-bottom: 1.5rem;
    margin-bottom: 2.5rem;
  }
  .league-header h1 {
    margin: 0;
    font-size: 2.5rem;
    color: #006a4e;
  }
  .league-header p {
    font-size: 1.2rem;
    color: #555;
    margin: 0.5rem 0 0 0;
  }
  .btn-join {
    display: inline-block;
    margin-top: 1.5rem;
    background-color: #006a4e;
    color: white;
    text-decoration: none;
    padding: 12px 25px;
    border-radius: 5px;
    font-weight: bold;
    transition: background-color 0.2s;
  }
  .btn-join:hover {
    background-color: #00563f;
  }

  /* --- Details Grid --- */
  .league-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
    border-top: 1px solid #e0e0e0;
    padding-top: 2rem;
  }
  .detail-card {
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #fdfdfd;
  }
  .detail-card h3 {
    margin-top: 0;
    color: #006a4e;
    border-bottom: 1px solid #ccc;
    padding-bottom: 0.5rem;
    font-size: 1.2rem;
  }

  /* --- Countdown Timer --- */
  .countdown-container {
    text-align: center;
    background-color: #ffffff;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.07);
    margin-bottom: 2rem;
  }
  .countdown-container h3 {
    margin-top: 0;
    font-family: "Merriweather", serif;
    color: #333;
  }
  .countdown-timer {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
  }
  .timer-box {
    background-color: #f7f7f7;
    padding: 1rem;
    border-radius: 8px;
    min-width: 80px;
  }
  .timer-box .time {
    font-size: 2rem;
    font-weight: bold;
    color: #006a4e;
  }
  .timer-box .label {
    font-size: 0.8rem;
    text-transform: uppercase;
    color: #6c757d;
  }

  /* --- Leaderboard --- */
  .leaderboard-container {
    margin-top: 2rem;
  }
  .leaderboard-container h2 {
    font-size: 1.8rem;
    color: #006a4e;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #006a4e;
  }
  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
  }
  .leaderboard-table th,
  .leaderboard-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  .leaderboard-table thead th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #6c757d;
    text-transform: uppercase;
    font-size: 0.85rem;
  }
  .leaderboard-table .rank {
    font-weight: bold;
  }
  .leaderboard-table .score {
    font-weight: bold;
    text-align: center;
  }
  .player-name-link {
    cursor: pointer;
    text-decoration: none;
    color: #006a4e;
    font-weight: bold;
  }
  .player-name-link:hover {
    text-decoration: underline;
  }
  .score-value {
    color: #555;
    margin-left: 0.75rem;
    font-weight: 800;
  }
  .score-positive {
    color: #006a4e;
  }
  .score-even,
  .score-negative {
    color: rgb(255, 9, 9);
  }
  .my-entry {
    background-color: #e8f5e9;
    border-left: 4px solid #006a4e;
  }
  .leaderboard-locked {
    text-align: center;
    padding: 2rem;
    border: 1px dashed #ccc;
    border-radius: 8px;
    margin-top: 2rem;
  }

  /* --- Player Stats Modal --- */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.6);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 2rem;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }
  .close-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .close-btn:hover,
  .close-btn:focus {
    color: black;
  }
  .player-stat {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
  }
  .player-stat:last-child {
    border-bottom: none;
  }
  .player-stat-label {
    font-weight: bold;
    color: #555;
  }
  .player-stat-value {
    font-weight: bold;
    color: #006a4e;
  }

  /* --- Responsive --- */
  @media (max-width: 768px) {
    .content-box {
      padding: 1.5rem;
    }
    .league-header h1 {
      font-size: 2rem;
    }
    .leaderboard-table thead {
      display: none;
    }
    .leaderboard-table,
    .leaderboard-table tbody,
    .leaderboard-table tr,
    .leaderboard-table td {
      display: block;
    }
    .leaderboard-table tr {
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .leaderboard-table td {
      text-align: right;
      padding-left: 50%;
      position: relative;
    }
    .leaderboard-table td::before {
      content: attr(data-label);
      position: absolute;
      left: 15px;
      width: 45%;
      padding-right: 10px;
      white-space: nowrap;
      font-weight: bold;
      text-align: left;
    }

    .leaderboard-table .score {
      font-weight: bold;
      text-align: right;
    }
  }
</style> -->

<div class="page-wrapper">
  <div class="league-container">
    <a
      href="{{ url_for('main.club_dashboard') if current_user.is_club_admin else url_for('main.user_dashboard') }}"
      class="back-to-dashboard"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        height="20px"
        viewBox="0 -960 960 960"
        width="20px"
        fill="currentColor"
      >
        <path d="M360-240 120-480l240-240 56 56-184 184 184 184-56 56Z"></path>
      </svg>
      Back to Dashboard
    </a>

    {% if not league.is_finalized and league.entry_deadline > now %}
    <div class="countdown-container">
      <h2>ENRTY DEADLINE</h2>
      <div
        id="countdown"
        class="countdown-timer"
        data-deadline="{{ league.entry_deadline.isoformat() }}"
      >
        <div class="timer-box">
          <span id="days" class="time">00</span><span class="label">Days</span>
        </div>
        <div class="timer-box">
          <span id="hours" class="time">00</span
          ><span class="label">Hours</span>
        </div>
        <div class="timer-box">
          <span id="minutes" class="time">00</span
          ><span class="label">Minutes</span>
        </div>
        <div class="timer-box">
          <span id="seconds" class="time">00</span
          ><span class="label">Seconds</span>
        </div>
      </div>
    </div>
    {% endif %} {% if league.is_finalized and league.winners %}
    <div class="winner-banner">
      <h2>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="32px"
          viewBox="0 -960 960 960"
          width="32px"
          fill="currentColor"
        >
          <path
            d="M220-180h520v-240l-60-60 60-60v-240H220v240l60 60-60 60v240Zm60-80v-184l-36-36 36-36v-184h400v184l36 36-36 36v184H280Zm200-260q25 0 42.5-17.5T540-580q0-25-17.5-42.5T480-640q-25 0-42.5 17.5T420-580q0 25 17.5 42.5T480-520Zm0-80q-8 0-14-6t-6-14q0-8 6-14t14-6q8 0 14 6t6 14q0 8-6 14t-14 6ZM220-80v-80h520v80H220Zm0-600v-80h520v80H220Zm260 260Z"
          ></path>
        </svg>
        League Winner!
      </h2>
      <p>
        <a
          href="{{ url_for('main.view_profile', user_id=league.winners[0].id) }}"
        >
          {{ league.winners[0].full_name }}
        </a>
      </p>
    </div>
    {% endif %}

    <div class="content-box">
      <div class="league-header">
        <h1>{{ league.name }}</h1>
        <p>League Code: <strong>{{ league.league_code }}</strong></p>
        {% if not current_user_entry and not league.has_entry_deadline_passed %}
        <a
          href="{{ url_for('league.add_entry', league_id=league.id) }}"
          class="btn-join"
          >Join This League</a
        >
        {% endif %}
      </div>

      <div class="league-details-grid">
        <div class="detail-card">
          <h3>Prize Details</h3>
          <p>{{ league.prize_details or 'Not specified.' }}</p>
        </div>
        <div class="detail-card">
          <h3>League Rules</h3>
          <p>{{ league.rules or 'Standard rules apply.' }}</p>
        </div>
        <div class="detail-card">
          <h3>Tournament Dates</h3>
          <p>
            <strong>Starts:</strong>
            {{ league.start_date.strftime('%d %b %Y, %H:%M') }}
          </p>
          <p>
            <strong>Ends:</strong>
            {{ league.end_date.strftime('%d %b %Y, %H:%M') }}
          </p>
        </div>
      </div>

      {% if league.has_entry_deadline_passed %}
      <div class="leaderboard-container">
        <h2>Leaderboard</h2>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th class="rank">Rank</th>
              <th>Entry Name</th>
              <th>Player 1</th>
              <th>Player 2</th>
              <th>Player 3</th>
              <th class="score">Total Score</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            {% for entry in entries %}
            <tr
              class="{% if entry.user_id == current_user.id %}my-entry{% endif %}"
            >
              <td class="rank" data-label="Rank">{{ loop.index }}</td>
              <td data-label="Entry Name">{{ entry.entry_name }}</td>

              <td data-label="Player 1" class="player-cell">
                <a
                  href="#"
                  class="player-name-link"
                  data-player-id="{{ entry.player1.dg_id }}"
                >
                  {{ entry.player1.full_name() }}
                </a>
                {% set score1 = scores.get(entry.player1_id, 0) %}
                <span
                  class="score-value {% if score1 > 0 %}score-positive{% elif score1 < 0 %}score-negative{% else %}score-even{% endif %}"
                >
                  {{ score1 }}
                </span>
              </td>

              <td data-label="Player 2" class="player-cell">
                <a
                  href="#"
                  class="player-name-link"
                  data-player-id="{{ entry.player2.dg_id }}"
                >
                  {{ entry.player2.full_name() }}
                </a>
                {% set score2 = scores.get(entry.player2_id, 0) %}
                <span
                  class="score-value {% if score2 > 0 %}score-positive{% elif score2 < 0 %}score-negative{% else %}score-even{% endif %}"
                >
                  {{ score2 }}
                </span>
              </td>

              <td data-label="Player 3" class="player-cell">
                <a
                  href="#"
                  class="player-name-link"
                  data-player-id="{{ entry.player3.dg_id }}"
                >
                  {{ entry.player3.full_name() }}
                </a>
                {% set score3 = scores.get(entry.player3_id, 0) %}
                <span
                  class="score-value {% if score3 > 0 %}score-positive{% elif score3 < 0 %}score-negative{% else %}score-even{% endif %}"
                >
                  {{ score3 }}
                </span>
              </td>

              <td
                class="score {% if entry.total_score > 0 %}score-positive{% elif entry.total_score < 0 %}score-negative{% else %}score-even{% endif %}"
                data-label="Total Score"
              >
                {{ entry.total_score }}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" style="text-align: center; padding: 2rem">
                No entries in this league yet.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="leaderboard-locked">
        <h3>Leaderboard Locked</h3>
        <p>
          The leaderboard will be revealed after the entry deadline has passed.
        </p>
        <p>
          <strong>Deadline:</strong>
          {{ league.entry_deadline.strftime('%A, %d %B %Y at %H:%M') }} (UTC)
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div id="playerStatsModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 id="modalPlayerName"></h2>
    <div id="modalPlayerStats"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Countdown Timer Logic ---
    const countdownElement = document.getElementById("countdown");
    if (countdownElement) {
      const deadline = new Date(
        countdownElement.dataset.deadline + "Z"
      ).getTime();
      const timer = setInterval(function () {
        const now = new Date().getTime();
        const distance = deadline - now;
        if (distance < 0) {
          clearInterval(timer);
          countdownElement.innerHTML =
            "<h3>The entry deadline has passed.</h3>";
          return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        document.getElementById("days").innerText = String(days).padStart(2, "0");
        document.getElementById("hours").innerText = String(hours).padStart(
          2,
          "0"
        );
        document.getElementById("minutes").innerText = String(minutes).padStart(
          2,
          "0"
        );
        document.getElementById("seconds").innerText = String(seconds).padStart(
          2,
          "0"
        );
      }, 1000);
    }

    // --- Player Stats Modal Logic ---
    const modal = document.getElementById("playerStatsModal");
    const closeBtn = document.querySelector(".modal .close-btn");
    const modalPlayerName = document.getElementById("modalPlayerName");
    const modalPlayerStats = document.getElementById("modalPlayerStats");

    const closeModal = () => {
      if (modal) modal.style.display = "none";
    };
    if (closeBtn) closeBtn.onclick = closeModal;
    window.onclick = (event) => {
      if (event.target == modal) closeModal();
    };

    function setupModalEventListeners() {
      document.querySelectorAll(".player-name-link").forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const playerId = this.dataset.playerId;
          modalPlayerName.textContent = "Loading...";
          modalPlayerStats.innerHTML = "";
          modal.style.display = "block";
          fetch(`/api/player-stats/${playerId}`)
            .then((response) => {
              if (!response.ok) {
                return response.json().then((errorData) => {
                  throw new Error(
                    errorData.error ||
                      `Server responded with status: ${response.status}`
                  );
                });
              }
              return response.json();
            })
            .then((data) => {
              modalPlayerName.textContent = data.player_name.replace(", ", " ");
              let statsHtml = `
                <div class="player-stat"><span class="player-stat-label">Strokes Gained: Total</span><span class="player-stat-value">${data.sg_total.toFixed(2)}</span></div>
                <div class="player-stat"><span class="player-stat-label">Strokes Gained: Putting</span><span class="player-stat-value">${data.sg_putt.toFixed(2)}</span></div>
                <div class="player-stat"><span class="player-stat-label">Strokes Gained: Approach</span><span class="player-stat-value">${data.sg_app.toFixed(2)}</span></div>
                <div class="player-stat"><span class="player-stat-label">Strokes Gained: Off the Tee</span><span class="player-stat-value">${data.sg_ott.toFixed(2)}</span></div>
                <div class="player-stat"><span class="player-stat-label">Driving Distance</span><span class="player-stat-value">${data.distance.toFixed(0)} yds</span></div>
                <div class="player-stat"><span class="player-stat-label">Driving Accuracy</span><span class="player-stat-value">${data.accuracy.toFixed(1)}%</span></div>
              `;
              modalPlayerStats.innerHTML = statsHtml;
            })
            .catch((error) => {
              modalPlayerName.textContent = "Error";
              modalPlayerStats.innerHTML = `<p>${error.message}</p>`;
              console.error("Error fetching player stats:", error);
            });
        });
      });
    }

    setupModalEventListeners();

    // --- Real-Time Leaderboard Logic ---
    const socket = io();
    const leagueId = {{ league.id }};
    socket.on("connect", () => {
      console.log("Socket connected, joining room:", `league_${leagueId}`);
      socket.emit("join", { room: `league_${leagueId}` });
    });
    socket.on("scores_updated", (data) => {
      if (data.league_id === leagueId) {
        updateLeaderboard();
      }
    });

    function updateLeaderboard() {
      fetch(`/league/api/${leagueId}/leaderboard`)
        .then((response) => response.json())
        .then((data) => {
          const leaderboardBody = document.getElementById("leaderboard-body");
          if (!leaderboardBody) return;
          leaderboardBody.innerHTML = ""; // Clear existing rows
          if (data.length === 0) {
            leaderboardBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem;">No entries in this league yet.</td></tr>`;
            return;
          }
          let rank = 1;
          data.forEach((entry) => {
            const row = document.createElement("tr");
            if (entry.is_current_user) {
              row.classList.add("my-entry");
            }
            // ... (construct and append row HTML based on new structure) ...
            // This part needs careful reconstruction matching the table structure
            leaderboardBody.appendChild(row);
            rank++;
          });
          // Re-attach modal listeners after updating leaderboard
          setupModalEventListeners();
        })
        .catch((error) => console.error("Error updating leaderboard:", error));
    }
  });
</script>
{% endblock %}
